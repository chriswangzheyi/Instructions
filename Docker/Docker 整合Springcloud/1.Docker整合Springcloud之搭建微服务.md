**Docker 整合 Springcloud 之 搭建微服务**



**1. 搭建步骤**

新建一个project docker_springcloud_demo

pom.xml：
	
	<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
	    <modelVersion>4.0.0</modelVersion>
	    <groupId>com.wzy</groupId>
	    <artifactId>docker_springcloud_demo</artifactId>
	    <version>0.0.1</version>
	    <packaging>pom</packaging>
	    <name>docker_springcloud_demo</name>
	    <url>http://maven.apache.org</url>
	    <modules>
	        <module>article</module>
	        <module>eureka_demo</module>
	        <module>zuul_demo</module>
	    </modules>
	
	    <!--- SprnigBoot父项目依赖 -->
	    <parent>
	        <groupId>org.springframework.boot</groupId>
	        <artifactId>spring-boot-starter-parent</artifactId>
	        <version>2.0.1.RELEASE</version>
	        <relativePath/>
	    </parent>
	
	    <properties>
	        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
	        <project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>
	        <java.version>1.8</java.version>
	    </properties>
	
	    <dependencies>
	        <!--web依赖 -->
	        <dependency>
	            <groupId>org.springframework.boot</groupId>
	            <artifactId>spring-boot-starter-web</artifactId>
	        </dependency>
	        <!-- 单元测试 -->
	        <dependency>
	            <groupId>org.springframework.boot</groupId>
	            <artifactId>spring-boot-starter-test</artifactId>
	            <scope>test</scope>
	        </dependency>
	    </dependencies>
	
	    <!-- 依赖 -->
	    <repositories>
	        <repository>
	            <id>spring-snapshots</id>
	            <name>Spring Snapshots</name>
	            <url>https://repo.spring.io/snapshot</url>
	            <snapshots>
	                <enabled>true</enabled>
	            </snapshots>
	        </repository>
	        <repository>
	            <id>spring-milestones</id>
	            <name>Spring Milestones</name>
	            <url>https://repo.spring.io/milestone</url>
	            <snapshots>
	                <enabled>false</enabled>
	            </snapshots>
	        </repository>
	    </repositories>
	
	    <!-- 插件 -->
	    <pluginRepositories>
	        <pluginRepository>
	            <id>spring-snapshots</id>
	            <name>Spring Snapshots</name>
	            <url>https://repo.spring.io/snapshot</url>
	            <snapshots>
	                <enabled>true</enabled>
	            </snapshots>
	        </pluginRepository>
	        <pluginRepository>
	            <id>spring-milestones</id>
	            <name>Spring Milestones</name>
	            <url>https://repo.spring.io/milestone</url>
	            <snapshots>
	                <enabled>false</enabled>
	            </snapshots>
	        </pluginRepository>
	    </pluginRepositories>
	
	    <dependencyManagement>
	        <dependencies>
	            <dependency>
	                <groupId>org.springframework.cloud</groupId>
	                <artifactId>spring-cloud-dependencies</artifactId>
	                <version>Finchley.M9</version>
	                <type>pom</type>
	                <scope>import</scope>
	            </dependency>
	        </dependencies>
	    </dependencyManagement>
	
	</project>


**2.准备数据库**

新建一个数据库： docker_test

新建一个表 tb_article


![](../Images/2.png)




**3. 新建article module**

搭建一个article 做简单的CRUD


![](../Images/1.png)


**ArticleController:**
	
	package com.wzy.article.controller;
	
	
	import com.wzy.article.pojo.Article;
	import com.wzy.article.pojo.Result;
	import com.wzy.article.service.ArticleService;
	import org.springframework.beans.factory.annotation.Autowired;
	import org.springframework.web.bind.annotation.*;
	
	import javax.servlet.http.HttpServletRequest;
	
	
	/**
	 * 文章Controller
	 */
	@RestController
	@RequestMapping("/article")
	public class ArticleController {
	
	    @Autowired
	    private ArticleService articleService;
	
	
	    @Autowired
	    private HttpServletRequest request;
	    /**
	     * 查询所有
	     */
	    @RequestMapping(method = RequestMethod.GET)
	    public Result findAll(){
	        return new Result(true,"查询成功:"+request.getLocalAddr(),articleService.findAll());
	    }
	
	    /**
	     * 查询一个
	     */
	    @RequestMapping(value = "/{id}",method = RequestMethod.GET)
	    public Result findById(@PathVariable Integer id){
	        return new Result(true,"查询成功",articleService.findById(id));
	    }
	
	    /**
	     * 添加
	     */
	    @RequestMapping(method = RequestMethod.POST)
	    public Result add(@RequestBody Article article){
	        articleService.add(article);
	        return new Result(true,"添加成功");
	    }
	
	    /**
	     * 修改
	     */
	    @RequestMapping(value = "/{id}",method = RequestMethod.PUT)
	    public Result update(@RequestBody Article article,@PathVariable Integer id){
	        article.setId(id);
	        articleService.update(article);
	        return new Result(true,"修改成功");
	    }
	
	    /**
	     * 删除
	     */
	    @RequestMapping(value = "/{id}",method = RequestMethod.DELETE)
	    public Result deleteById(@PathVariable Integer id){
	        articleService.deleteById(id);
	        return new Result(true,"删除成功");
	    }
	}


**ArticleDao:**

	package com.wzy.article.dao;
	
	
	import com.wzy.article.pojo.Article;
	import org.springframework.data.jpa.repository.JpaRepository;
	
	/**
	 * 文章dao
	 */
	public interface ArticleDao extends JpaRepository<Article,Integer>{
	
	}


**Article:**

	package com.wzy.article.pojo;
	
	import javax.persistence.*;
	import java.io.Serializable;
	import java.util.Date;
	
	/**
	 *文章实体
	 */
	@Entity
	@Table(name = "tb_article")
	public class Article implements Serializable{
	
	    @Id
	    @GeneratedValue(strategy = GenerationType.IDENTITY)
	    private Integer id;
	    private String title;
	    private String content;
	    private String author;
	    private Date addtime;
	
	    public Integer getId() {
	        return id;
	    }
	
	    public void setId(Integer id) {
	        this.id = id;
	    }
	
	    public String getTitle() {
	        return title;
	    }
	
	    public void setTitle(String title) {
	        this.title = title;
	    }
	
	    public String getContent() {
	        return content;
	    }
	
	    public void setContent(String content) {
	        this.content = content;
	    }
	
	    public String getAuthor() {
	        return author;
	    }
	
	    public void setAuthor(String author) {
	        this.author = author;
	    }
	
	    public Date getAddtime() {
	        return addtime;
	    }
	
	    public void setAddtime(Date addtime) {
	        this.addtime = addtime;
	    }
	}




**Result:**

	package com.wzy.article.pojo;
	
	import java.io.Serializable;
	
	/**
	 * 统一返回数据实体类
	 */
	public class Result implements Serializable{
	
	    private Boolean flag; //是否成功
	    private String message;//消息
	    private Object data;//返回数据
	
	    public Result() {
	    }
	
	    public Result(Boolean flag, String message) {
	        this.flag = flag;
	        this.message = message;
	    }
	
	    public Result(Boolean flag, String message, Object data) {
	        this.flag = flag;
	        this.message = message;
	        this.data = data;
	    }
	
	    public Boolean getFlag() {
	        return flag;
	    }
	
	    public void setFlag(Boolean flag) {
	        this.flag = flag;
	    }
	
	    public String getMessage() {
	        return message;
	    }
	
	    public void setMessage(String message) {
	        this.message = message;
	    }
	
	    public Object getData() {
	        return data;
	    }
	
	    public void setData(Object data) {
	        this.data = data;
	    }
	}



**ArticleService:**

	package com.wzy.article.service;
	
	import com.wzy.article.pojo.Article;
	import java.util.List;
	
	/**
	 * 文章service接口
	 */
	public interface ArticleService {
	
	    public List<Article> findAll();
	
	    public Article findById(Integer id);
	
	    public void add(Article article);
	
	    public void update(Article article);
	
	    public void deleteById(Integer id);
	}



**ArticleServiceImpl:**

	package com.wzy.article.service;
	
	import com.wzy.article.dao.ArticleDao;
	import com.wzy.article.pojo.Article;
	import org.springframework.beans.factory.annotation.Autowired;
	import org.springframework.stereotype.Service;
	
	import java.util.List;
	
	/**
	 * 文章service实现
	 */
	@Service
	public class ArticleServiceImpl implements ArticleService {
	
	    @Autowired
	    private ArticleDao articleDao;
	
	    @Override
	    public List<Article> findAll() {
	        return articleDao.findAll();
	    }
	
	    @Override
	    public Article findById(Integer id) {
	        return articleDao.findById(id).get();
	    }
	
	    @Override
	    public void add(Article article) {
	        articleDao.save(article);
	    }
	
	    @Override
	    public void update(Article article) {
	        articleDao.save(article);
	    }
	
	    @Override
	    public void deleteById(Integer id) {
	        articleDao.deleteById(id);
	    }
	}


**ArticleApplication:**

	package com.wzy.article;
	
	import org.springframework.boot.SpringApplication;
	import org.springframework.boot.autoconfigure.SpringBootApplication;
	
	@SpringBootApplication
	public class ArticleApplication {
	
	    public static void main(String[] args) {
	        SpringApplication.run(ArticleApplication.class, args);
	    }
	
	}


**application.yml:**
	
	server:
	  port: 9001
	spring:
	  application:
	    name: article
	  datasource:
	    url: jdbc:mysql://localhost:3306/docker_test?characterEncoding=UTF8&serverTimezone=UTC
	    driver-class-name: com.mysql.jdbc.Driver
	    username: root
	    password: root
	  jpa:
	    database: mysql
	    show-sql: true
	    generate-ddl: true
	eureka:
	  client:
	    register-with-eureka: true
	    fetch-registry: true
	    service-url:
	      defaultZone: http://localhost:7000/eureka
	  instance:
	    prefer-ip-address: true
	    #instance-id: article.com  如果需要在eureka注册多个服务，不能写死instance-id


**pom:**


	<?xml version="1.0" encoding="UTF-8"?>
	<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
	
	    <parent>
	        <artifactId>docker_springcloud_demo</artifactId>
	        <groupId>com.wzy</groupId>
	        <version>0.0.1</version>
	    </parent>
	    <modelVersion>4.0.0</modelVersion>
	
	    <artifactId>article</artifactId>
	
	    <dependencies>
	        <dependency>
	            <groupId>org.springframework.boot</groupId>
	            <artifactId>spring-boot-starter-data-jpa</artifactId>
	        </dependency>
	        <dependency>
	            <groupId>mysql</groupId>
	            <artifactId>mysql-connector-java</artifactId>
	        </dependency>
	
	        <dependency>
	            <groupId>org.springframework.cloud</groupId>
	            <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
	        </dependency>
	    </dependencies>
	
	    <build>
	        <finalName>app</finalName>
	        <plugins>
	            <plugin>
	                <groupId>org.springframework.boot</groupId>
	                <artifactId>spring-boot-maven-plugin</artifactId>
	            </plugin>
	            <!-- docker的maven插件，官网：https://github.com/spotify/docker-maven-plugin -->
	            <plugin>
	                <groupId>com.spotify</groupId>
	                <artifactId>docker-maven-plugin</artifactId>
	                <version>0.4.13</version>
	                <configuration>
	                    <!-- 注意imageName一定要是符合正则[a-z0-9-_.]的，否则构建不会成功 -->
	                    <!-- 详见：https://github.com/spotify/docker-maven-plugin    Invalid repository name ... only [a-z0-9-_.] are allowed-->
	                    <imageName>article</imageName>
	                    <baseImage>jdk1.8</baseImage>
	                    <entryPoint>["java", "-jar", "/${project.build.finalName}.jar"]</entryPoint>
	                    <resources>
	                        <resource>
	                            <targetPath>/</targetPath>
	                            <directory>${project.build.directory}</directory>
	                            <include>${project.build.finalName}.jar</include>
	                        </resource>
	                    </resources>
	                    <dockerHost>http://192.168.66.138:2375</dockerHost>
	                </configuration>
	            </plugin>
	        </plugins>
	    </build>
	</project>

---


**4. 新建eureka_demo module**

![](../Images/3.png)


**EurekaApplication:**

	package com.wzy;
	
	import org.springframework.boot.SpringApplication;
	import org.springframework.boot.autoconfigure.SpringBootApplication;
	import org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;
	
	/**
	 * 注册中心微服务
	 */
	@SpringBootApplication
	@EnableEurekaServer
	public class EurekaApplication {
	
	    public static void main(String[] args) {
	        SpringApplication.run(EurekaApplication.class,args);
	    }
	
	}


**application.yml:**

	server:
	  port: 7000
	spring:
	  application:
	    name: eureka_demo
	eureka:
	  client:
	    register-with-eureka: false
	    fetch-registry: false
	    service-url:
	      defaultZone: http://localhost:${server.port}/eureka



**5. 验证**

启动 article 和 eureka_demo 两个项目

请求：

    http://localhost:9001/article


查看eureka:

    http://localhost:7000/


---

**6. 新增一个zuul module：**


![](../Images/4.png)



**ZuulApplication:**

	package com.wzy;
	
	import org.springframework.boot.SpringApplication;
	import org.springframework.boot.autoconfigure.SpringBootApplication;
	import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
	import org.springframework.cloud.netflix.zuul.EnableZuulProxy;
	
	/**
	 * 微服务网关
	 */
	@SpringBootApplication
	@EnableZuulProxy
	@EnableEurekaClient
	public class ZuulApplication {
	
	    public static void main(String[] args) {
	        SpringApplication.run(ZuulApplication.class,args);
	    }
	
	}

**application.yml:**

	server:
	  port: 8888
	spring:
	  application:
	    name: zuul
	zuul:
	  routes:
	    app:
	      path: /app/*
	      serviceId: article
	eureka:
	  client:
	    register-with-eureka: true
	    fetch-registry: true
	    service-url:
	      defaultZone: http://localhost:7000/eureka
	  instance:
	    prefer-ip-address: true
	    instance-id: zuul.com


zuul 此时将app 下的请求转发到article中（article是eureka中的application name）


pom.xml：

	<?xml version="1.0" encoding="UTF-8"?>
	<project xmlns="http://maven.apache.org/POM/4.0.0"
	         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
	    <parent>
	        <artifactId>docker_springcloud_demo</artifactId>
	        <groupId>com.wzy</groupId>
	        <version>0.0.1</version>
	    </parent>
	    <modelVersion>4.0.0</modelVersion>
	
	    <artifactId>zuul_demo</artifactId>
	
	    <dependencies>
	        <dependency>
	            <groupId>org.springframework.cloud</groupId>
	            <artifactId>spring-cloud-starter-netflix-zuul</artifactId>
	        </dependency>
	
	        <dependency>
	            <groupId>org.springframework.cloud</groupId>
	            <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
	        </dependency>
	    </dependencies>
	
	    <build>
	        <finalName>app</finalName>
	        <plugins>
	            <plugin>
	                <groupId>org.springframework.boot</groupId>
	                <artifactId>spring-boot-maven-plugin</artifactId>
	            </plugin>
	            <!-- docker的maven插件，官网：https://github.com/spotify/docker-maven-plugin -->
	            <plugin>
	                <groupId>com.spotify</groupId>
	                <artifactId>docker-maven-plugin</artifactId>
	                <version>0.4.13</version>
	                <configuration>
	                    <!-- 注意imageName一定要是符合正则[a-z0-9-_.]的，否则构建不会成功 -->
	                    <!-- 详见：https://github.com/spotify/docker-maven-plugin    Invalid repository name ... only [a-z0-9-_.] are allowed-->
	                    <imageName>192.168.66.138:5000/zuul</imageName>
	                    <baseImage>jdk1.8</baseImage>
	                    <entryPoint>["java", "-jar", "/${project.build.finalName}.jar"]</entryPoint>
	                    <resources>
	                        <resource>
	                            <targetPath>/</targetPath>
	                            <directory>${project.build.directory}</directory>
	                            <include>${project.build.finalName}.jar</include>
	                        </resource>
	                    </resources>
	                    <dockerHost>http://192.168.66.138:2375</dockerHost>
	                </configuration>
	            </plugin>
	        </plugins>
	    </build>
	</project>


**7. 验证：**

启动

article

eureka_demo

zuul_demo

然后访问：

    http://localhost:8888/app/article
