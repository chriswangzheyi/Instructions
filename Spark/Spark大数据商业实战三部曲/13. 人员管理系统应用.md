#13. 人员管理系统应用
参考：https://zhuanlan.zhihu.com/p/401320521


## 代码

	package com.wzy
	
	import org.apache.spark.sql.functions.{avg, count, countDistinct, current_date, mean, sum}
	import org.apache.spark.sql.{DataFrame, SparkSession, functions}
	
	object PeopleManagement {
	
	  def main(args: Array[String]): Unit = {
	
	    val spark = SparkSession.builder()
	      .appName("people management")
	      .master("spark://192.168.2.123:7077")
	      //本地测试运行需要加这一句话，部署在生产环境则删除
	      .config("spark.jars", "/Users/zheyiwang/IdeaProjects/SparkApps/target/SparkApps-1.0-SNAPSHOT-jar-with-dependencies.jar")
	      .getOrCreate()
	    val sc = spark.sparkContext
	    import spark.implicits._
	
	    val persons = spark.read.json("hdfs://192.168.2.121:9000/data/people.json")
	    val personScores = spark.read.json("hdfs://192.168.2.121:9000/data/peopleScores.json")
	
	    val personDS = persons.as[Person]
	    val personScoreDS = personScores.as[PersonScore]
	
	    println("----------------个人信息原始数据dataset-------------------------")
	    personDS.show()
	    println("-----------------个人信息数据结构信息-------------------------------")
	    personScoreDS.printSchema()
	    println("----------------评分原始数据dataset-------------------------")
	    personScoreDS.show()
	    println("-----------------评分数据结构信息-------------------------------")
	    personScoreDS.printSchema()
	
	    //实例操作1 给每位员工的年龄增加100 (Map算子)
	    val DSperson = personDS.map {
	      Person => {
	        (Person.name, Person.age + 100)
	      }
	    }
	
	    println("----------------实例操作1结果-------------------------")
	    DSperson.show()
	
	    //实例操作2 给特定的员工年龄增加70，其他增加30(flatmap算子)
	    println("----------------实例操作2结果-------------------------")
	    personDS.flatMap(
	      persons => persons match {
	        case Person(name, age) if(name == "Andy") => List((name, age+70))
	        case Person(name,age) => List((name, age+30))
	      }
	    ).show()
	
	    //实例操作3 对人员信息中的重复数据进行去重 (dropDuplicates 和 distinct)
	    println("----------------实例操作3结果-------------------------")
	
	    println("--------------dropDuplicates-----------------")
	    personDS.dropDuplicates("name").show()
	    //dropDuplicates和distinct()的区别在于，distinct()会返回一个新的dataset，而dropDuplicates是在原始数据上进行操作的
	    println("--------------distinct()-----------------")
	    val distvalue = personDS.distinct()
	    distvalue.show()
	
	    //实例操作4 按年龄进行降序排序
	    println("----------------实例操作4结果-------------------------")
	    personDS.sort($"age".desc).show()
	
	    //实例操作5 将两个表格进行合并
	    println("----------------实例操作5结果-------------------------")
	    println("使用join算子关联企业人员信息，企业人员评分信息")
	    personDS.join(personScoreDS,$"name"=== $"n").show()
	
	    //使用joinWith进行内关联，返回一个tuple
	    println("使用joinWith算子关联企业人员信息、企业人员分数评估")
	    personDS.joinWith(personScoreDS,$"name" === $"n").show()
	
	
	    //实例操作6 进行随机采样分析
	    println("----------------实例操作6结果-------------------------")
	    println("使用randoomsplit算子进行随机切分")
	    //randoomsplit的参数weights表示权重
	    personDS.randomSplit(Array(10,20)).foreach(dataset => dataset.show()) //后面有几个数，就会按照权重被拆分为几个RDD
	
	    println("使用sample进行随机采样，第一个参数为true时，表示有放回采样")
	    personDS.sample(false,0.5).show()
	
	
	    //实例操作7 选择某一列进行展示
	    //select选择年龄进行展示
	    println("----------------实例操作7结果-------------------------")
	    println("使用select算子选择列")
	    personDS.select("name").show()
	
	    //实例操作8 进行分组统计分析
	    println("----------------实例操作8结果-------------------------")
	    println("按照姓名进行分组")
	    val personDSGrouped_single: DataFrame = personDS.groupBy($"name").count()
	    personDSGrouped_single.show()
	
	    println("按照姓名，年龄进行分组")
	    val personDSGrouped: DataFrame = personDS.groupBy($"name",$"age").count()
	    personDSGrouped.show()
	
	    //实例操作9 将两列合并为一列
	    println("----------------实例操作9结果-------------------------")
	    println("使用agg算子concat内置函数，将姓名、年龄链接在一起，成为单个字符串列")
	    personDS.groupBy($"name",$"age")
	      .agg(
	        functions.concat($"name",$"age")
	      ).show
	
	    //实例操作10 计算平均年龄、最大年龄等
	    println("----------------实例操作10结果-------------------------")
	    personDS.groupBy($"name")
	      .agg(sum($"age"),avg($"age"),functions.max($"age"),functions.min($"age"),count($"age"),countDistinct($"age"),mean($"age"),
	        current_date())
	      .show()
	
	  }
	
	  case class Person(name:String,age:Long)
	  case class PersonScore(n:String,score:Long)
	}


## 打印

	----------------个人信息原始数据dataset-------------------------
	+---+-------+
	|age|   name|
	+---+-------+
	| 16|Michael|
	| 30|   Andy|
	| 19| Justin|
	| 29| Justin|
	| 46|Michael|
	+---+-------+
	
	-----------------个人信息数据结构信息-------------------------------
	root
	 |-- n: string (nullable = true)
	 |-- score: long (nullable = true)
	
	----------------评分原始数据dataset-------------------------
	+-------+-----+
	|      n|score|
	+-------+-----+
	|Michael|   88|
	|   Andy|  100|
	| Justin|   89|
	+-------+-----+
	
	-----------------评分数据结构信息-------------------------------
	root
	 |-- n: string (nullable = true)
	 |-- score: long (nullable = true)
	
	----------------实例操作1结果-------------------------
	+-------+---+
	|     _1| _2|
	+-------+---+
	|Michael|116|
	|   Andy|130|
	| Justin|119|
	| Justin|129|
	|Michael|146|
	+-------+---+
	
	----------------实例操作2结果-------------------------
	+-------+---+
	|     _1| _2|
	+-------+---+
	|Michael| 46|
	|   Andy|100|
	| Justin| 49|
	| Justin| 59|
	|Michael| 76|
	+-------+---+
	
	----------------实例操作3结果-------------------------
	--------------dropDuplicates-----------------
	+---+-------+
	|age|   name|
	+---+-------+
	| 16|Michael|
	| 30|   Andy|
	| 19| Justin|
	+---+-------+
	
	--------------distinct()-----------------
	+---+-------+
	|age|   name|
	+---+-------+
	| 46|Michael|
	| 30|   Andy|
	| 19| Justin|
	| 16|Michael|
	| 29| Justin|
	+---+-------+
	
	----------------实例操作4结果-------------------------
	+---+-------+
	|age|   name|
	+---+-------+
	| 46|Michael|
	| 30|   Andy|
	| 29| Justin|
	| 19| Justin|
	| 16|Michael|
	+---+-------+
	
	----------------实例操作5结果-------------------------
	使用join算子关联企业人员信息，企业人员评分信息
	+---+-------+-------+-----+
	|age|   name|      n|score|
	+---+-------+-------+-----+
	| 16|Michael|Michael|   88|
	| 30|   Andy|   Andy|  100|
	| 19| Justin| Justin|   89|
	| 29| Justin| Justin|   89|
	| 46|Michael|Michael|   88|
	+---+-------+-------+-----+
	
	使用joinWith算子关联企业人员信息、企业人员分数评估
	+-------------+-------------+
	|           _1|           _2|
	+-------------+-------------+
	|{16, Michael}|{Michael, 88}|
	|   {30, Andy}|  {Andy, 100}|
	| {19, Justin}| {Justin, 89}|
	| {29, Justin}| {Justin, 89}|
	|{46, Michael}|{Michael, 88}|
	+-------------+-------------+
	----------------实例操作6结果-------------------------
	使用randoomsplit算子进行随机切分
	+---+-------+
	|age|   name|
	+---+-------+
	| 16|Michael|
	| 46|Michael|
	+---+-------+
	+---+------+
	|age|  name|
	+---+------+
	| 19|Justin|
	| 29|Justin|
	| 30|  Andy|
	+---+------+
	
	使用sample进行随机采样，第一个参数为true时，表示有放回采样
	+---+-------+
	|age|   name|
	+---+-------+
	| 16|Michael|
	| 30|   Andy|
	| 19| Justin|
	| 29| Justin|
	| 46|Michael|
	+---+-------+
	
	----------------实例操作7结果-------------------------
	使用select算子选择列
	+-------+
	|   name|
	+-------+
	|Michael|
	|   Andy|
	| Justin|
	| Justin|
	|Michael|
	+-------+
	
	----------------实例操作8结果-------------------------
	按照姓名进行分组
	+-------+-----+
	|   name|count|
	+-------+-----+
	|Michael|    2|
	|   Andy|    1|
	| Justin|    2|
	+-------+-----+
	
	按照姓名，年龄进行分组
	+-------+---+-----+
	|   name|age|count|
	+-------+---+-----+
	| Justin| 29|    1|
	|   Andy| 30|    1|
	|Michael| 16|    1|
	|Michael| 46|    1|
	| Justin| 19|    1|
	+-------+---+-----+
	
	----------------实例操作9结果-------------------------
	使用agg算子concat内置函数，将姓名、年龄链接在一起，成为单个字符串列
	+-------+---+-----------------+
	|   name|age|concat(name, age)|
	+-------+---+-----------------+
	| Justin| 29|         Justin29|
	|   Andy| 30|           Andy30|
	|Michael| 16|        Michael16|
	|Michael| 46|        Michael46|
	| Justin| 19|         Justin19|
	+-------+---+-----------------+
	
	----------------实例操作10结果-------------------------
	+-------+--------+--------+--------+--------+----------+----------+--------+--------------+
	|   name|sum(age)|avg(age)|max(age)|min(age)|count(age)|count(age)|avg(age)|current_date()|
	+-------+--------+--------+--------+--------+----------+----------+--------+--------------+
	|Michael|      62|    31.0|      46|      16|         2|         2|    31.0|    2023-02-05|
	|   Andy|      30|    30.0|      30|      30|         1|         1|    30.0|    2023-02-05|
	| Justin|      48|    24.0|      29|      19|         2|         2|    24.0|    2023-02-05|
	+-------+--------+--------+--------+--------+----------+----------+--------+--------------+