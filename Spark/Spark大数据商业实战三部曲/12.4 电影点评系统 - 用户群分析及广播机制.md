# 12.4 电影点评系统 - 用户群分析及广播机制

## 前提条件

12.1-12.3

## 代码

	    //客群分析
	    val targetQQusers = usersRDD.map(_.split("::")).map( x=> (x(0),x(2))).filter(_._2.equals("18"))  //(UserID,Age)
	    val targetTaobaoUsers = usersRDD.map(_.split("::")).map( x=> (x(0),x(2))).filter(_._2.equals("25"))  //(UserID,Age)
	    val targetQQUserSet =  HashSet() ++ targetQQusers.map(_._1).collect()  //所有符合情况的userid
	    val targetTaobaoUserSet = HashSet() ++ targetTaobaoUsers.map(_._1).collect() //所有符合情况的userid
	
	    val targetQQUsersBroadcast = sc.broadcast(targetQQUserSet)
	    val targetTaobaoUsersBroadcast = sc.broadcast(targetTaobaoUserSet)
	
	    val movieID2Name = moviesRDD.map(_.split("::")).map(x => (x(0), x(1))).collect().toMap //（MovieID，Title）
	
	    println("所有电影中QQ或者微信核心用户最喜爱电影TopN分析：")
	    ratingsRDD.map(_.split("::")).map( x=> (x(0),x(1))) //(UserID,MovieID)
	      .filter( x => targetQQUsersBroadcast.value.contains(x._1)) // 用ratingsRDD去比对广播变量targetQQUsersBroadcast中的userId,匹配则留下
	      .map( x => ( x._2, 1)) //（MovieID，1）
	      .reduceByKey( _+_ ) //（MovieID，总喜欢次数）
	      .map( x => (x._2,x._1)) //（总喜欢数量，MovieID）
	      .sortByKey(false) //降序排列
	      .map( x => (x._2,x._1)) // （MovieID，总喜欢数量）
	      .take(10)
	      .map( x =>( movieID2Name.getOrElse(x._1,null),x._2)) //（总喜欢数量，MovieID）
	      .foreach(println)
	
	    println("所有电影中淘宝核心用户最喜爱电影TopN分析：")
	    ratingsRDD.map(_.split("::")).map( x=> (x(0),x(1))) //(UserID,MovieID)
	      .filter( x => targetTaobaoUsersBroadcast.value.contains(x._1)) // 用ratingsRDD去比对广播变量targetQQUsersBroadcast中的userId,匹配则留下
	      .map( x => ( x._2, 1)) //（MovieID，1）
	      .reduceByKey( _+_ ) //（MovieID，总喜欢次数）
	      .map( x => (x._2,x._1)) //（总喜欢数量，MovieID）
	      .sortByKey(false) //降序排列
	      .map( x => (x._2,x._1)) // （MovieID，总喜欢数量）
	      .take(10)
	      .map( x =>( movieID2Name.getOrElse(x._1,null),x._2)) //（总喜欢数量，MovieID）
	      .foreach(println)



## 打印

	所有电影中QQ或者微信核心用户最喜爱电影TopN分析：
	(American Beauty (1999),715)
	(Star Wars: Episode VI - Return of the Jedi (1983),586)
	(Star Wars: Episode V - The Empire Strikes Back (1980),579)
	(Matrix, The (1999),567)
	(Star Wars: Episode IV - A New Hope (1977),562)
	(Braveheart (1995),544)
	(Saving Private Ryan (1998),543)
	(Jurassic Park (1993),541)
	(Terminator 2: Judgment Day (1991),529)
	(Sixth Sense, The (1999),514)
	
	所有电影中淘宝核心用户最喜爱电影TopN分析：
	(American Beauty (1999),1334)
	(Star Wars: Episode V - The Empire Strikes Back (1980),1176)
	(Star Wars: Episode VI - Return of the Jedi (1983),1134)
	(Star Wars: Episode IV - A New Hope (1977),1128)
	(Terminator 2: Judgment Day (1991),1087)
	(Silence of the Lambs, The (1991),1067)
	(Matrix, The (1999),1049)
	(Saving Private Ryan (1998),1017)
	(Back to the Future (1985),1001)
	(Jurassic Park (1993),1000)
	


其他可以参考1.1