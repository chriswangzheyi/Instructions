# 12.1电影点评系统-数据统计

## 数据准备

电影推荐系统MovieLens M1数据

ml-1m

### ratings.dat格式

	1. UserID:M:ovieID: Rating::Timestamp 
	2. 用 户 I D、电 影 I D、评 分 数 据 、时 间 戳
	3. 一 用 户 工D 范 围 在 1 ~ 6040 之 间
	4. 一电影 ID范围在1 ~3952 之间
	5. 一 评级:使用五星评分方式
	6. 一 时间戳表示系统记录的时间
	7. 一每个用户至少有20 个评级

### users.dat 格式

	 UserID: :Gender: :Age: :0ccupation: :zip-code 
	用户id、性别、年龄、职业、邮编代码
	
	性别:y ”是男性、“E”是女性
	
	- 年龄由以下范围选择:
	* 1:"少于18岁”
	* 18:"18年龄段:从18岁到24岁”
	* 25: "25年龄段:从25岁到34岁"
	* 35: "35岁年龄段:从 35 岁到44 岁"
	* 45: "45岁年龄段:从45岁到49岁"
    * 50: "50岁年龄段:从50岁到55岁"
	* 56: 56岁年龄段:大于56岁"

### movies.dat  格式
	MovieID::Title::Genres
	
	- 电影类型包括以 下类型:
	* Act ion:行动
	* Adventure:冒险
	* Animation:动画
	* Children's: 儿童
	* Comedy:喜剧
	* Crime:犯罪
	*  Docuentary:紀永片
	* Drama:戏剧
	* Fantasy: 幻想
	* Film-Noir: 黑色申影
	* Horror: 恐怖
	* Musical : 音乐
	* Mysterv:神秘
	* Romance:浪漫
	* Sci-Fi: 科幻
	*Thriller: 悰悚
	*War:試争
	
###occupations.dat   格式

	OccupationID: :Occupation
	
	- 职 业 包 含 如 下选 择 :
	* 0: “ 其他” 或 末指定
	* 1：“ 学木/教育者”
	* 2：“ 艺 术 家”
	* 3：“ 文书/ 行政”
	*4：“高校毕业生”
	*5: “客户服务”
	*6:“医生/ 保健”
	*7:“ 行政/ 管理”
	*8:“农民”
	*9:“ 家 庭 主妇 ”
	*10：“ 中小学生”
	* 1 1：“律师”
	* 12: “程序員”
	* 13:“ 退休”
	* 14:“ 销售/ 市场营销”
	* 15:“ 科学家”
	* 16:“ 个体户”
	* 17:“ 技术员/ 工程师”
	* 18:“商人和工匠”

## 用户统计Demo

### Movie_Users_analyzer_RDD

	package com.wzy
	
	import org.apache.spark.sql.SparkSession
	
	object Movie_Users_analyzer_RDD {
	
	  def main(args: Array[String]): Unit = {
	
	    val spark = SparkSession.builder()
	      .appName("spark dataset")
	      .master("spark://192.168.2.123:7077")
	      //本地测试运行需要加这一句话，部署在生产环境则删除
	      .config("spark.jars", "/Users/zheyiwang/IdeaProjects/SparkApps/target/SparkApps-1.0-SNAPSHOT-jar-with-dependencies.jar")
	      .getOrCreate()
	    val sc = spark.sparkContext
	    import spark.implicits._
	
	    val usersRDD = sc.textFile("hdfs://192.168.2.121:9000/data/users.dat")
	    val moviesRDD = sc.textFile("hdfs://192.168.2.121:9000/data/movies.dat")
	    val ratingsRDD = sc.textFile("hdfs://192.168.2.121:9000/data/ratings.dat")
	    val ocupationsRDD = sc.textFile("hdfs://192.168.2.121:9000/data/occupations.dat")
	
	    //userbasic
	    val usersBasic = usersRDD.map( _.split("::")).map{user =>
	      ( //UserID:Gender::Age::OccupationID
	        user(3),
	        (user(0),user(1),user(2))
	      )
	    }
	
	    for ( elem <- usersBasic.collect().take(2)){
	      println("usersBasicRDD (职业id，（用户id，性别，年龄）)" + elem)
	    }
	
	    //occupations
	    val occupations = ocupationsRDD.map(_.split("::")).map(job => (job(0),job(1)))
	
	    for ( elem <- occupations.collect().take(2)){
	      println("occupations （职业id，职业名）" + elem)
	    }
	
	    //user information
	    val userInformation = usersBasic.join(occupations)
	    userInformation.cache()
	
	    for ( elem <- userInformation.collect().take(2)){
	      println("userInformation （职业id，(（用户id，性别，年龄），职业名)）" + elem)
	    }
	
	    //目标电影
	    val targetMovie = ratingsRDD.map(_.split("::")).map( x => (x(0), x(1))).filter(_._2.equals("1193"))
	
	    for ( elem <- targetMovie.collect().take(2)){
	      println("targetMovie （用户id，电影id)）" + elem)
	    }
	
	    // 目标用户
	    val targetUsers = userInformation.map( x => (x._2._1._1,x._2))
	    for ( elem <- userInformation.collect().take(2)){
	      println("userInformation （用户id，（（用户ID，性别，年龄）），职业名)）" + elem)
	    }
	
	    println("电影点评系统用户行为分析，统计观看电影id是1193的电影用户信息：用户ID、性别、年龄、职业名")
	    val userInformationForSpecificMovie = targetMovie.join(targetUsers)
	    for (elem <- userInformationForSpecificMovie.collect().take(10)){
	      println("userInformationForSpecificMovie(用户id，（电影id，((用户id，性别，年龄)，职业名))" + elem)
	    }
	
	  }
	}

### POM

	<?xml version="1.0" encoding="UTF-8"?>
	<project xmlns="http://maven.apache.org/POM/4.0.0"
	         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
	    <modelVersion>4.0.0</modelVersion>
	
	    <groupId>org.example</groupId>
	    <artifactId>SparkApps</artifactId>
	    <version>1.0-SNAPSHOT</version>
	
	    <properties>
	        <maven.compiler.source>8</maven.compiler.source>
	        <maven.compiler.target>8</maven.compiler.target>
	        <scala.version>2.12.10</scala.version>
	        <spark.version>3.1.2</spark.version>
	    </properties>
	
	    <dependencies>
	        <dependency>
	            <groupId>org.scala-lang</groupId>
	            <artifactId>scala-compiler</artifactId>
	            <version>${scala.version}</version>
	        </dependency>
	
	        <dependency>
	            <groupId>org.scala-lang</groupId>
	            <artifactId>scala-library</artifactId>
	            <version>${scala.version}</version>
	        </dependency>
	
	        <dependency>
	            <groupId>org.scala-lang</groupId>
	            <artifactId>scala-reflect</artifactId>
	            <version>${scala.version}</version>
	        </dependency>
	
	        <dependency>
	            <groupId>org.scala-lang</groupId>
	            <artifactId>scala-compiler</artifactId>
	            <version>${scala.version}</version>
	        </dependency>
	
	        <dependency>
	            <groupId>org.apache.spark</groupId>
	            <artifactId>spark-core_2.12</artifactId>
	            <version>${spark.version}</version>
	        </dependency>
	
	        <dependency>
	            <groupId>org.apache.spark</groupId>
	            <artifactId>spark-launcher_2.12</artifactId>
	            <version>${spark.version}</version>
	        </dependency>
	
	        <dependency>
	            <groupId>org.apache.spark</groupId>
	            <artifactId>spark-sql_2.12</artifactId>
	            <version>${spark.version}</version>
	        </dependency>
	
	        <dependency>
	            <groupId>org.apache.spark</groupId>
	            <artifactId>spark-streaming_2.12</artifactId>
	            <version>${spark.version}</version>
	        </dependency>
	
	    </dependencies>
	
	    <repositories>
	        <repository>
	            <id>nexus-aliyun</id>
	            <name>Nexus aliyun</name>
	            <layout>default</layout>
	            <url>http://maven.aliyun.com/nexus/content/groups/public</url>
	            <snapshots>
	                <enabled>false</enabled>
	                <updatePolicy>never</updatePolicy>
	            </snapshots>
	            <releases>
	                <enabled>true</enabled>
	                <updatePolicy>never</updatePolicy>
	            </releases>
	        </repository>
	
	    </repositories>
	
	    <pluginRepositories>
	        <pluginRepository>
	            <id>ali-plugin</id>
	            <url>http://maven.aliyun.com/nexus/content/groups/public/</url>
	            <snapshots>
	                <enabled>false</enabled>
	                <updatePolicy>never</updatePolicy>
	            </snapshots>
	            <releases>
	                <enabled>true</enabled>
	                <updatePolicy>never</updatePolicy>
	            </releases>
	        </pluginRepository>
	    </pluginRepositories>
	
	    <build>
	        <plugins>
	            <!-- 指定编译java的插件 -->
	            <plugin>
	                <groupId>org.apache.maven.plugins</groupId>
	                <artifactId>maven-compiler-plugin</artifactId>
	                <version>3.5.1</version>
	                <configuration>
	                    <source>1.8</source>
	                    <target>1.8</target>
	                </configuration>
	            </plugin>
	
	            <!-- 指定编译scala的插件 -->
	            <plugin>
	                <groupId>net.alchim31.maven</groupId>
	                <artifactId>scala-maven-plugin</artifactId>
	                <version>3.2.2</version>
	                <executions>
	                    <execution>
	                        <goals>
	                            <goal>compile</goal>
	                            <goal>testCompile</goal>
	                        </goals>
	                        <configuration>
	                            <args>
	                                <arg>-dependencyfile</arg>
	                                <arg>${project.build.directory}/.scala_dependencies</arg>
	                            </args>
	                        </configuration>
	                    </execution>
	                </executions>
	            </plugin>
	
	
	            <!--  把依赖jar中的用到的类，提取到自己的jar中 -->
	            <plugin>
	                <groupId>org.apache.maven.plugins</groupId>
	                <artifactId>maven-assembly-plugin</artifactId>
	                <version>2.6</version>
	                <configuration>
	                    <archive>
	                        <manifest>
	                            <mainClass></mainClass>
	                        </manifest>
	                    </archive>
	                    <descriptorRefs>
	                        <descriptorRef>jar-with-dependencies</descriptorRef>
	                    </descriptorRefs>
	                </configuration>
	                <!--下面是为了使用 mvn package命令，如果不加则使用mvn assembly-->
	                <executions>
	                    <execution>
	                        <id>make-assemble</id>
	                        <phase>package</phase>
	                        <goals>
	                            <goal>single</goal>
	                        </goals>
	                    </execution>
	                </executions>
	            </plugin>
	        </plugins>
	    </build>
	
	</project>

### 打印结果

	occupations （职业id，职业名）( 0,other or not specified)
	occupations （职业id，职业名）( 1,academic/educator)
	userInformation （职业id，(（用户id，性别，年龄），职业名)）(20,((3080,M,25),writer))
	userInformation （职业id，(（用户id，性别，年龄），职业名)）(20,((3093,F,45),writer))
	targetMovie （用户id，电影id)）(1,1193)
	targetMovie （用户id，电影id)）(2,1193)
	userInformation （用户id，（（用户ID，性别，年龄）），职业名)）(20,((3080,M,25),writer))
	userInformation （用户id，（（用户ID，性别，年龄）），职业名)）(20,((3093,F,45),writer))
	电影点评系统用户行为分析，统计观看电影id是1193的电影用户信息：用户ID、性别、年龄、职业名
	userInformationForSpecificMovie(用户id，（电影id，((用户id，性别，年龄)，职业名))(5319,(1193,((5319,M,18),technician/engineer)))
	userInformationForSpecificMovie(用户id，（电影id，((用户id，性别，年龄)，职业名))(4286,(1193,((4286,M,35),technician/engineer)))
	userInformationForSpecificMovie(用户id，（电影id，((用户id，性别，年龄)，职业名))(5975,(1193,((5975,M,25),sales/marketing)))
	userInformationForSpecificMovie(用户id，（电影id，((用户id，性别，年龄)，职业名))(792,(1193,((792,M,25),technician/engineer)))
	userInformationForSpecificMovie(用户id，（电影id，((用户id，性别，年龄)，职业名))(3159,(1193,((3159,F,25),scientist)))
	userInformationForSpecificMovie(用户id，（电影id，((用户id，性别，年龄)，职业名))(178,(1193,((178,M,56),technician/engineer)))
	userInformationForSpecificMovie(用户id，（电影id，((用户id，性别，年龄)，职业名))(749,(1193,((749,M,35),tradesman/craftsman)))
	userInformationForSpecificMovie(用户id，（电影id，((用户id，性别，年龄)，职业名))(929,(1193,((929,M,25),scientist)))
	userInformationForSpecificMovie(用户id，（电影id，((用户id，性别，年龄)，职业名))(729,(1193,((729,M,35),programmer)))
	userInformationForSpecificMovie(用户id，（电影id，((用户id，性别，年龄)，职业名))(4466,(1193,((4466,M,35),lawyer)))