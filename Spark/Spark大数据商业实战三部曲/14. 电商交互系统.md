# 14. 电商交互系统

## 数据准备

### user.json 


	( "userID": userID-Value, "name": name-Value, registeredTime--Value}
	用户 ID/ 值对、用户姓名/ 值对、注册时间/ 值对
	
	- userID: 用户ID。
	userID - value : 用户ID的值 。
	name : 用户姓名。
	name- Value:用户姓名的值。
	- registeredTime:用户注册时间。
	- registeredTime--Value:具体注册时间的值

### log.json

	{"1ogID": 1og1D-Value,"user ID":userID-Value, mtime": time-Value, ntyped": typed-Value, "consumed"":consumed-Value }
	日志 ID/值对，用户ID/值对，时间/值对，类型/值对，消费金额/值对
	
	- logID: HiID.
	1ogID -Value: 日志ID值 。
	userID: 用户ID。
	- userID-Value:用户ID的值。
	time:注册时间。
	time - Value : 具体注册时间的值。
	typed:类型。typed=0 为用户访问电商网站; typed=1是用户在电商网站购买商品。 
	- t yped- Value : 类型的值。
	- consumed:消费金额。
	- consume d - Value:消费金额的值

## 代码

	package com.wzy
	
	import org.apache.spark.sql.{Dataset, SparkSession}
	import org.apache.spark.sql.functions.{count, date_add, round, sum}
	
	object Eshop {
	
	  case class UserLog(logID: Long, userID: Long, time: String, typed: Long, consumed: Double)
	  case class LogOnce(logID: Long, userID: Long, count: Long)
	  case class ConsumedOnce(logID: Long, userID: Long, consumed: Double)
	
	  def main(args: Array[String]): Unit = {
	
	    val spark = SparkSession.builder()
	      .appName("people management")
	      .master("spark://192.168.2.123:7077")
	      //本地测试运行需要加这一句话，部署在生产环境则删除
	      .config("spark.jars", "/Users/zheyiwang/IdeaProjects/SparkApps/target/SparkApps-1.0-SNAPSHOT-jar-with-dependencies.jar")
	      .getOrCreate()
	    val sc = spark.sparkContext
	    import spark.implicits._
	
	    val userInfo = spark.read.format("json").json( "hdfs://192.168.2.121:9000/data/user.json")
	    val userLog = spark.read.format("json").json("hdfs://192.168.2.121:9000/data/log.json")
	    val userInfo_parquet= spark.read.format("parquest").parquet("hdfs://192.168.2.121:9000/data/userparquet.parquet")
	    val userLog_parquest= spark.read.format("parquest").parquet("hdfs://192.168.2.121:9000/data/logparquet.parquet")
	
	    val startTime = "2016-10-01"
	    val endTime = "2016-11-01"
	
	
	    println("功能一 ：统计特定时间段访问次数最多的Top5: 例如2016-10-01 ~ 2016-11-01 :")
	    userLog.filter("time >= '" + startTime + "' and time <= '" + endTime + "' and typed = 0")
	      .join(userInfo, userInfo("userID") === userLog("userID"))  //consumed|logID|time|typed|userID|name|registeredTime|userID
	      .groupBy(userInfo("userID"), userInfo("name"))
	      .agg(count(userLog("logID")).alias("userLogCount"))
	      .sort($"userLogCount".desc)
	      .limit(5)
	      .show()
	
	
	    println("功能二：统计特定时间段内用户购买总金额排名TopN:")
	    userLog.filter("time >= '" + startTime + "' and time <= '" + endTime + "'")
	      .join(userInfo, userInfo("userID") === userLog("userID"))
	      .groupBy(userInfo("userID"), userInfo("name"))
	      .agg(round(sum(userLog("consumed")), 2).alias("totalCount"))  //保留2位小数取整
	      .sort($"totalCount".desc)
	      .limit(10)
	      .show()
	
	
	    println("功能三：统计特定时间段内用户访问次数增长排名TopN:")
	    val userAccessTemp: Dataset[LogOnce] = userLog.as[UserLog].filter("time >= '2016-10-08' and time <= '2016-10-14' and typed = '0'")
	      .map(log => LogOnce(log.logID, log.userID, 1))  //logid, userid, 正向计数
	      .union(userLog.as[UserLog].filter("time >= '2016-10-01' and time <= '2016-10-07' and typed = '0'")
	        .map(log => LogOnce(log.logID, log.userID, -1)))  //logid, userid, 负向计数
	
	    userAccessTemp.join(userInfo, userInfo("userID") === userAccessTemp("userID"))
	      .groupBy(userInfo("userID"), userInfo("name"))
	      .agg(round(sum(userAccessTemp("count")), 2).alias("viewIncreasedTmp"))
	      .sort($"viewIncreasedTmp".desc)
	      .limit(10)
	      .show()
	
	    userLog_parquest.createOrReplaceTempView("userLog_parquest")
	
	    println("作业1：读parquest，统计特定时间段购买金额最多的Top5: 例如2016-10-01 ~ 2016-11-01 :")
	    userLog_parquest.filter("time >= '2016-10-01' and time<='2016-11-01' ")
	      .join(userInfo_parquet, userLog_parquest("userID") === userInfo_parquet("userID"))
	      .groupBy(userInfo_parquet("userID"), userInfo_parquet("name"))
	      .agg( round( sum(userLog_parquest("consumed")),2 ).alias("totalConsumed"))
	      .sort($"totalConsumed".desc)
	      .show(5)
	
	
	    println("作业2：统计注册之后前两周内访问最多的前Top10:")
	    userLog_parquest.join(userInfo_parquet,userLog_parquest("userID") === userInfo_parquet("userID"))
	      .filter(
	        userInfo_parquet("registeredTime") >= "2016-10-01"
	        && userInfo_parquet("registeredTime") <= "2016-10-14"
	        && userLog_parquest("time") >= userInfo_parquet("registeredTime")
	        && userLog_parquest("time") <= date_add(userLog_parquest("time"),14))
	      .groupBy(userInfo_parquet("userID"), userInfo_parquet("name"))
	      .agg( count(userLog_parquest("logID")).alias("logTimes"))
	      .sort($"logTimes".desc)
	      .limit(10)
	      .show()
	  }
	}
	

## 打印

	功能一 ：统计特定时间段访问次数最多的Top5: 例如2016-10-01 ~ 2016-11-01 :
	+------+-------+------------+
	|userID|   name|userLogCount|
	+------+-------+------------+
	|    39|spark39|          45|
	|    11|spark11|          39|
	|     9| spark9|          39|
	|    25|spark25|          38|
	|    76|spark76|          38|
	+------+-------+------------+
	
	功能二：统计特定时间段内用户购买总金额排名TopN:
	+------+-------+----------+
	|userID|   name|totalCount|
	+------+-------+----------+
	|    92|spark92|   20109.1|
	|    14|spark14|  19991.64|
	|    40|spark40|  19098.22|
	|    64|spark64|  19095.71|
	|    46|spark46|  18895.19|
	|    41|spark41|  18878.94|
	|    10|spark10|  18489.67|
	|    80|spark80|  18003.31|
	|    84|spark84|  18002.74|
	|    49|spark49|  17902.01|
	+------+-------+----------+
	
	功能三：统计特定时间段内用户访问次数增长排名TopN:
	+------+-------+----------------+
	|userID|   name|viewIncreasedTmp|
	+------+-------+----------------+
	|     8| spark8|              10|
	|    52|spark52|               9|
	|    20|spark20|               7|
	|    28|spark28|               7|
	|    78|spark78|               7|
	|    75|spark75|               7|
	|    34|spark34|               6|
	|    85|spark85|               6|
	|    22|spark22|               6|
	|    88|spark88|               6|
	+------+-------+----------------+
	
	作业1：读parquest，统计特定时间段购买金额最多的Top5: 例如2016-10-01 ~ 2016-11-01 :
	+------+-------+-------------+
	|userID|   name|totalConsumed|
	+------+-------+-------------+
	|    92|spark92|      20109.1|
	|    14|spark14|     19991.64|
	|    40|spark40|     19098.22|
	|    64|spark64|     19095.71|
	|    46|spark46|     18895.19|
	+------+-------+-------------+
	
	作业2：统计注册之后前两周内访问最多的前Top10:
	+------+-------+--------+
	|userID|   name|logTimes|
	+------+-------+--------+
	|    92|spark92|      82|
	|    64|spark64|      78|
	|    11|spark11|      77|
	|    59|spark59|      77|
	|    40|spark40|      76|
	|    65|spark65|      71|
	|     8| spark8|      71|
	|    27|spark27|      69|
	|     3| spark3|      68|
	|     5| spark5|      66|
	+------+-------+--------+