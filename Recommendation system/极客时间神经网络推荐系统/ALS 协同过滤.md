# ALS 协同过滤



## 代码

	package com.sparrowrecsys.offline.spark.model
	
	import org.apache.spark.SparkConf
	import org.apache.spark.ml.evaluation.{BinaryClassificationEvaluator, RegressionEvaluator}
	import org.apache.spark.ml.recommendation.ALS
	import org.apache.spark.ml.tuning.{CrossValidator, ParamGridBuilder}
	import org.apache.spark.sql.SparkSession
	import org.apache.spark.sql.functions._
	
	object CollaborativeFiltering {
	
	  def main(args: Array[String]): Unit = {
	    val conf = new SparkConf()
	      .setMaster("local")
	      .setAppName("collaborativeFiltering")
	      .set("spark.submit.deployMode", "client")
	
	    val spark = SparkSession.builder.config(conf).getOrCreate()
	    spark.sparkContext.setLogLevel("ERROR")
	    val ratingResourcesPath = this.getClass.getResource("/webroot/sampledata/ratings.csv")
	    val toInt = udf[Int, String]( _.toInt)
	    val toFloat = udf[Double, String]( _.toFloat)
	    val ratingSamples = spark.read.format("csv").option("header", "true").load(ratingResourcesPath.getPath)
	      .withColumn("userIdInt", toInt(col("userId")))
	      .withColumn("movieIdInt", toInt(col("movieId")))
	      .withColumn("ratingFloat", toFloat(col("rating")))
	
	    val Array(training, test) = ratingSamples.randomSplit(Array(0.8, 0.2))
	
	    // Build the recommendation model using ALS on the training data
	    val als = new ALS()
	      .setMaxIter(5)
	      .setRegParam(0.01)
	      .setUserCol("userIdInt")
	      .setItemCol("movieIdInt")
	      .setRatingCol("ratingFloat")
	
	    val model = als.fit(training)
	
	    // Evaluate the model by computing the RMSE on the test data
	    // Note we set cold start strategy to 'drop' to ensure we don't get NaN evaluation metrics
	    model.setColdStartStrategy("drop")
	    val predictions = model.transform(test)
	
	    model.itemFactors.show(10, truncate = false)
	    model.userFactors.show(10, truncate = false)
	
	    val evaluator = new RegressionEvaluator()
	      .setMetricName("rmse")
	      .setLabelCol("ratingFloat")
	      .setPredictionCol("prediction")
	    val rmse = evaluator.evaluate(predictions)
	    println(s"Root-mean-square error = $rmse")
	
	    // Generate top 10 movie recommendations for each user
	    val userRecs = model.recommendForAllUsers(10)
	    // Generate top 10 user recommendations for each movie
	    val movieRecs = model.recommendForAllItems(10)
	
	    // Generate top 10 movie recommendations for a specified set of users
	    val users = ratingSamples.select(als.getUserCol).distinct().limit(3)
	    val userSubsetRecs = model.recommendForUserSubset(users, 10)
	    // Generate top 10 user recommendations for a specified set of movies
	    val movies = ratingSamples.select(als.getItemCol).distinct().limit(3)
	    val movieSubSetRecs = model.recommendForItemSubset(movies, 10)
	    // $example off$
	    userRecs.show(false)
	    movieRecs.show(false)
	    userSubsetRecs.show(false)
	    movieSubSetRecs.show(false)
	
	    val paramGrid = new ParamGridBuilder()
	      .addGrid(als.regParam, Array(0.01))
	      .build()
	
	    val cv = new CrossValidator()
	      .setEstimator(als)
	      .setEvaluator(evaluator)
	      .setEstimatorParamMaps(paramGrid)
	      .setNumFolds(10)  // Use 3+ in practice
	    val cvModel = cv.fit(test)
	    val avgMetrics = cvModel.avgMetrics
	
	    spark.stop()
	  }
	}


## 打印

Item embedding：
	
	+---+---------------------------------------------------------------------------------------------------------------------------------+
	|id |features                                                                                                                         |
	+---+---------------------------------------------------------------------------------------------------------------------------------+
	|10 |[-0.03908938, -0.122823596, 0.12843409, 0.094280854, -0.13538545, -0.6335315, -0.051677316, 0.19910605, -0.1278034, 0.10128482]  |
	|20 |[0.06220399, -0.028828762, -0.3538859, -0.039154135, -0.38280553, -0.18311538, 0.135493, 0.014354266, -0.40467232, 0.40037316]   |
	|30 |[-0.3556966, -0.18822405, -0.62073296, 0.17484184, 0.32630926, -0.07081877, -0.12100714, 0.41575754, 0.07282739, 0.37962228]     |
	|40 |[-0.5451631, -0.77148646, -0.06142046, 0.04143146, -0.20027101, -0.284929, -0.046237122, 0.1511117, 0.42496526, 0.5866094]       |
	|50 |[-0.39734924, 0.34614187, -0.02515076, -0.02292168, 0.16056295, -0.35531557, 0.010965625, 0.30112398, -0.1669048, 0.30190626]    |
	|60 |[-0.24074872, -0.32198453, -0.533113, -0.031546112, 0.21827042, -0.16696064, 0.1660228, -0.106247514, -0.10856441, 0.42986736]   |
	|70 |[-0.057054307, -0.012827729, 0.18145962, -0.40170953, 0.030374527, 0.086509354, -0.08691471, 0.27671173, -0.25380787, 0.96413195]|
	|80 |[-0.29926723, 0.103542626, -0.6777982, 0.037004024, 0.6598614, 0.27894056, -0.26713634, 0.9663561, 0.17457785, 0.42273796]       |
	|90 |[-0.25428316, 0.17343369, -0.9263782, 1.0246421, -0.49993235, -0.09361567, 0.10113861, 0.7519703, -0.61980855, -0.21372111]      |
	|100|[-0.2927108, 0.11007541, -0.2550766, -0.047998305, -0.27114466, -0.3453799, -0.11498396, -0.07659699, -0.27608454, 0.27712882]   |
	+---+---------------------------------------------------------------------------------------------------------------------------------+
	only showing top 10 rows

user embedding：

	
	+---+------------------------------------------------------------------------------------------------------------------------+
	|id |features                                                                                                                |
	+---+------------------------------------------------------------------------------------------------------------------------+
	|10 |[-2.962079, 1.5854635, -2.00274, 0.0684647, 0.6272969, -3.4659457, -0.5068747, 1.8513217, -0.25526702, 2.2195458]       |
	|20 |[-3.3908377, 0.1796381, 0.07691779, -0.6121709, -0.9211682, -1.3060576, -0.9477944, 2.6622777, -0.8900832, 2.128403]    |
	|30 |[-3.733292, -2.3281863, -0.45952043, -0.22641025, 0.27463752, -3.1923304, 0.59648573, 0.59921575, 1.220202, 2.079367]   |
	|40 |[-4.959536, -0.5017102, -0.6470105, -1.5523341, -0.6068725, -3.1123054, -3.3798866, 0.7877704, -0.5261039, -0.7327593]  |
	|50 |[-2.861229, 0.2903087, -1.2557211, -1.9389164, 0.19948667, -4.2294354, 0.6191292, 1.6089135, -0.772039, 2.8109043]      |
	|60 |[-2.6755216, -1.8362383, -0.6284258, -0.36879793, -0.38982576, -3.8666453, 2.0221577, 2.164147, -1.1402708, 2.50259]    |
	|70 |[-3.3606808, 0.9588932, 0.36066133, -1.2672067, 0.087008536, -1.8484821, 0.6792191, 3.3066866, -2.0351915, 1.6871884]   |
	|80 |[-2.7880466, 1.135614, -0.8690157, 0.06441277, -0.7746153, -3.5667539, -1.0627538, 0.82386386, -0.14173831, 3.3543081]  |
	|90 |[-2.8288746, -0.4368149, -1.4375635, -0.22968812, -0.7955674, -4.1991315, 1.9033436, 0.93147546, -0.98576754, 3.0379384]|
	|100|[-2.5132782, 0.29577574, -1.172677, -0.059549082, 1.213817, -2.8842728, 0.6054671, 2.0589528, -0.73647356, 3.1007853]   |
	+---+------------------------------------------------------------------------------------------------------------------------+
	only showing top 10 rows
	

rmse	
		
	Root-mean-square error = 0.9091081015435355

top 10 movie recommendations for each user:


	+---------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
	|userIdInt|recommendations                                                                                                                                                                  |
	+---------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
	|148      |[[966, 6.0111923], [776, 5.8158045], [439, 5.780028], [702, 5.6963415], [651, 5.6186247], [939, 5.5493565], [752, 5.4402514], [34, 5.187733], [400, 5.0929437], [130, 5.0860558]]|
	|463      |[[749, 6.135047], [776, 5.8323116], [644, 5.8019223], [620, 5.768186], [696, 5.7494454], [167, 5.4931183], [654, 5.4782577], [114, 5.246808], [651, 5.1306553], [864, 5.080631]] |
	|471      |[[749, 6.446323], [845, 6.1087832], [620, 5.6581945], [644, 5.604782], [791, 5.3389125], [797, 5.257564], [400, 5.1351776], [660, 5.0951147], [213, 5.0018864], [651, 4.9828424]]|
	|496      |[[749, 7.7442207], [644, 6.042036], [865, 5.546731], [394, 5.376479], [136, 5.365672], [134, 5.0833836], [757, 5.078474], [961, 5.077954], [260, 4.920787], [202, 4.750456]]     |
	|833      |[[980, 6.4700975], [545, 5.960183], [644, 5.863906], [130, 5.848791], [591, 5.70481], [394, 5.688467], [463, 5.5766754], [887, 5.4378514], [734, 5.261697], [525, 5.145362]]     |
	|1088     |[[394, 7.463842], [545, 6.123293], [980, 5.773737], [130, 5.236144], [286, 5.0945163], [992, 5.0695987], [865, 4.8897915], [644, 4.777103], [576, 4.5021067], [525, 4.3476453]]  |
	|1238     |[[136, 6.398314], [651, 6.326437], [614, 6.199709], [633, 5.9138927], [676, 5.7017226], [723, 5.6446733], [503, 5.552635], [794, 5.5278645], [77, 5.4452066], [961, 5.282625]]   |
	|1342     |[[887, 10.661222], [845, 7.7461367], [791, 7.427244], [138, 7.3141274], [853, 7.3063974], [772, 7.2602596], [874, 7.176423], [570, 7.1587396], [797, 7.1208224], [844, 6.998005]]|
	|1580     |[[411, 10.959322], [749, 8.489348], [850, 8.023727], [820, 7.831811], [789, 7.1289945], [958, 6.6974764], [966, 6.6789336], [975, 6.336855], [624, 6.1906414], [636, 6.1795645]] |
	|1591     |[[394, 7.06678], [33, 6.2586336], [404, 6.2436557], [614, 6.2002945], [69, 6.0834126], [626, 6.0731964], [651, 5.9918337], [139, 5.9557447], [644, 5.9448786], [738, 5.938419]]  |
	|1645     |[[749, 7.7792587], [644, 5.617524], [134, 5.049033], [845, 4.983179], [701, 4.925733], [106, 4.90713], [620, 4.8870454], [696, 4.8063645], [527, 4.699404], [720, 4.68799]]      |
	|1829     |[[749, 9.132801], [394, 6.4834933], [644, 6.068633], [324, 5.4453177], [769, 5.4416804], [865, 5.347985], [139, 5.295495], [924, 5.2753725], [767, 5.2629843], [683, 5.1771035]] |
	|1959     |[[394, 6.0691013], [887, 5.1078024], [644, 4.6490884], [33, 4.2254534], [591, 4.0940213], [992, 4.084769], [865, 4.065827], [139, 4.0415397], [109, 3.971333], [767, 3.9498608]] |
	|2122     |[[749, 9.191097], [884, 8.093519], [768, 7.6980233], [614, 7.6340265], [845, 7.252898], [404, 7.170562], [690, 7.121445], [654, 7.1112356], [658, 7.0936327], [651, 7.0457253]]  |
	|2142     |[[676, 9.096633], [749, 8.900386], [723, 7.844069], [652, 7.842761], [136, 7.60518], [167, 7.4427423], [530, 7.3287582], [654, 7.021502], [696, 6.985016], [651, 6.894799]]      |
	|2366     |[[644, 6.1999803], [789, 6.1168485], [591, 6.0209475], [887, 6.020671], [925, 5.9908123], [130, 5.98215], [463, 5.768017], [525, 5.7246857], [980, 5.7194853], [385, 5.675359]]  |
	|2659     |[[749, 12.419652], [787, 7.4359293], [136, 6.919373], [757, 6.5150175], [794, 6.3901906], [389, 6.181323], [701, 6.0099216], [629, 5.8867316], [583, 5.8465576], [975, 5.846]]   |
	|2866     |[[749, 8.183869], [676, 6.6183014], [652, 6.554145], [696, 6.0183945], [654, 5.9346256], [167, 5.570341], [776, 5.4477797], [632, 5.2696023], [389, 5.250779], [501, 5.2094045]] |
	|3175     |[[749, 13.936373], [411, 7.820695], [652, 7.4133825], [961, 6.8310413], [794, 6.8030653], [649, 6.100677], [658, 5.9248495], [984, 5.895959], [850, 5.846869], [389, 5.8277845]] |
	|3749     |[[845, 8.281923], [794, 7.8113112], [758, 7.621603], [791, 7.4282155], [980, 7.2228565], [793, 7.1758943], [138, 7.1681533], [797, 7.088584], [844, 7.0264354], [749, 6.977809]] |
	+---------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
	only showing top 20 rows

// Generate top 10 user recommendations for each movie:
	
	+----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
	|movieIdInt|recommendations                                                                                                                                                                                    |
	+----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
	|471       |[[6949, 6.295514], [28144, 6.086795], [11917, 6.0859737], [20577, 5.9280124], [14186, 5.8478055], [1396, 5.797655], [27533, 5.685387], [26459, 5.669119], [27421, 5.6211405], [18530, 5.5989313]]  |
	|463       |[[24829, 8.526972], [25990, 8.442967], [28670, 8.331649], [24864, 8.170171], [29949, 8.067249], [28067, 7.982208], [28368, 7.6781735], [5040, 7.6493216], [1083, 7.5326586], [7875, 7.457494]]     |
	|833       |[[27060, 6.482048], [9353, 6.2632327], [23258, 6.1976004], [3354, 6.0152235], [15207, 6.0036607], [16194, 5.954321], [21779, 5.9417834], [25648, 5.940529], [21109, 5.937975], [14278, 5.9062905]] |
	|496       |[[26294, 8.034677], [27533, 7.688124], [532, 7.558569], [15411, 7.515018], [23897, 7.3922005], [19395, 7.3544617], [20577, 7.3175], [4561, 7.2446594], [12423, 7.138737], [12146, 7.0355678]]      |
	|148       |[[18995, 9.6150875], [8020, 9.25049], [16055, 9.156256], [6041, 8.660053], [14188, 8.58926], [26031, 8.308946], [16791, 8.200722], [18000, 8.158891], [19773, 8.104528], [20176, 8.06279]]         |
	|540       |[[9353, 6.547873], [20250, 6.528678], [8892, 6.2630115], [5340, 5.774622], [23258, 5.5874457], [12338, 5.490431], [16872, 5.475552], [24829, 5.468033], [3615, 5.4594955], [24474, 5.4008946]]     |
	|392       |[[26031, 10.013198], [14974, 9.437815], [14147, 9.407385], [27545, 9.000578], [27633, 8.358503], [4068, 8.277352], [6704, 8.205513], [644, 8.174267], [6406, 8.02925], [22347, 7.9836297]]         |
	|243       |[[18643, 11.7465725], [27332, 10.025188], [27545, 9.13053], [7245, 8.806561], [21062, 8.521349], [24829, 8.446867], [26441, 8.332559], [1213, 8.308949], [2763, 8.282658], [13995, 8.244961]]      |
	|623       |[[14147, 11.106533], [18000, 11.010771], [27103, 10.540972], [26031, 10.29635], [24829, 10.0485], [9353, 9.78268], [14974, 9.643594], [1459, 9.635415], [27354, 9.617598], [24089, 9.509451]]      |
	|737       |[[28759, 7.557933], [18349, 6.9766436], [26882, 6.8979836], [25648, 6.8715253], [1425, 6.7661147], [6153, 6.7164617], [11375, 6.5403795], [24294, 6.523287], [26091, 6.387358], [14152, 6.3218093]]|
	|897       |[[24829, 8.534081], [21753, 7.5212364], [27533, 7.3981757], [14711, 7.1598186], [17929, 7.0023317], [2655, 6.971204], [11211, 6.925681], [24455, 6.9215527], [1409, 6.90864], [5846, 6.8900137]]   |
	|858       |[[7827, 7.0143423], [10529, 6.5300503], [25961, 6.250274], [19625, 6.229455], [20291, 6.205774], [17345, 6.2020555], [13596, 6.1873446], [15515, 6.1574144], [23217, 6.119561], [24825, 6.0978312]]|
	|31        |[[8892, 5.9675636], [5747, 5.761612], [1059, 5.547223], [20250, 5.4111004], [24503, 5.395185], [5680, 5.3568525], [23341, 5.324687], [5340, 5.3243585], [22114, 5.31754], [27295, 5.312991]]       |
	|516       |[[7245, 4.9103637], [21101, 4.896605], [24590, 4.876867], [27765, 4.8683195], [8892, 4.838562], [11805, 4.829171], [22062, 4.7553988], [2057, 4.730569], [4404, 4.7269497], [7215, 4.720487]]      |
	|580       |[[28252, 8.657523], [26294, 8.3420315], [395, 7.998514], [26200, 7.986586], [13127, 7.979158], [6949, 7.943866], [23813, 7.881403], [20571, 7.8126197], [18460, 7.8075113], [20577, 7.7650013]]    |
	|251       |[[7245, 11.79875], [24829, 9.989488], [19532, 9.4075985], [27332, 8.99954], [21111, 8.812646], [22191, 8.609151], [3386, 8.503731], [5747, 8.496283], [16353, 8.302709], [29996, 8.226598]]        |
	|451       |[[26294, 9.676165], [18460, 8.285288], [20577, 7.978486], [395, 7.694228], [13039, 7.444067], [17933, 7.3543973], [14188, 7.112949], [28555, 7.108502], [8461, 6.9254746], [19536, 6.8635387]]     |
	|85        |[[10133, 6.3481026], [27187, 6.3398314], [13388, 6.149082], [4466, 6.100705], [15162, 6.090913], [20854, 6.0568137], [4675, 6.0479503], [9445, 5.9962764], [29708, 5.9797797], [25706, 5.9580445]] |
	|137       |[[19410, 13.924919], [27332, 13.457328], [4354, 11.420866], [7310, 11.309286], [7597, 11.281185], [24053, 11.201289], [9886, 11.127776], [2763, 11.028149], [3386, 11.022322], [6829, 10.977657]]  |
	|808       |[[7597, 9.628954], [8892, 7.9656816], [2530, 7.6364594], [11086, 7.5180974], [27187, 7.449582], [18824, 7.3809695], [15801, 7.365655], [12004, 7.2994885], [4791, 7.2172318], [667, 6.9834824]]    |
	+----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
	only showing top 20 rows


Generate top 10 movie recommendations for a specified set of users:
	
	+---------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
	|userIdInt|recommendations                                                                                                                                                                  |
	+---------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
	|471      |[[749, 6.446323], [845, 6.1087832], [620, 5.6581945], [644, 5.604782], [791, 5.3389125], [797, 5.257564], [400, 5.1351776], [660, 5.0951147], [213, 5.0018864], [651, 4.9828424]]|
	|463      |[[749, 6.135047], [776, 5.8323116], [644, 5.8019223], [620, 5.768186], [696, 5.7494454], [167, 5.4931183], [654, 5.4782577], [114, 5.246808], [651, 5.1306553], [864, 5.080631]] |
	|148      |[[966, 6.0111923], [776, 5.8158045], [439, 5.780028], [702, 5.6963415], [651, 5.6186247], [939, 5.5493565], [752, 5.4402514], [34, 5.187733], [400, 5.0929437], [130, 5.0860558]]|
	+---------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
	
Generate top 10 user recommendations for a specified set of movies:	
	
	+----------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
	|movieIdInt|recommendations                                                                                                                                                                                   |
	+----------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
	|471       |[[6949, 6.295514], [28144, 6.086795], [11917, 6.0859737], [20577, 5.9280124], [14186, 5.8478055], [1396, 5.797655], [27533, 5.685387], [26459, 5.669119], [27421, 5.6211405], [18530, 5.5989313]] |
	|463       |[[24829, 8.526972], [25990, 8.442967], [28670, 8.331649], [24864, 8.170171], [29949, 8.067249], [28067, 7.982208], [28368, 7.6781735], [5040, 7.6493216], [1083, 7.5326586], [7875, 7.457494]]    |
	|833       |[[27060, 6.482048], [9353, 6.2632327], [23258, 6.1976004], [3354, 6.0152235], [15207, 6.0036607], [16194, 5.954321], [21779, 5.9417834], [25648, 5.940529], [21109, 5.937975], [14278, 5.9062905]]|
	+----------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
	
