Zuul过滤


为zuul添加安全认证


**1.新增配置类**


![](../Images/39.png)




**ZuulConfig:**


	package com.wzy.config;
	
	import com.wzy.filter.AuthorizedRequestFilter;
	import org.springframework.context.annotation.Bean;
	import org.springframework.context.annotation.Configuration;
	
	
	
	@Configuration
	public class ZuulConfig {
		@Bean
		public AuthorizedRequestFilter getAuthorizedRequestFilter() {
			return new AuthorizedRequestFilter() ;
		}
	}



**AuthorizedRequestFilter:**

	package com.wzy.filter;
	
	import java.nio.charset.Charset;
	import java.util.Base64;
	
	import com.netflix.zuul.ZuulFilter;
	import com.netflix.zuul.context.RequestContext;
	
	public class AuthorizedRequestFilter extends ZuulFilter {	// 进行授权访问处理
	
		@Override
		public Object run() {	// 表示具体的过滤执行操作
			RequestContext currentContext = RequestContext.getCurrentContext() ; // 获取当前请求的上下文
			String auth = "mldnjava:hello"; // 认证的原始信息
			byte[] encodedAuth = Base64.getEncoder()
					.encode(auth.getBytes(Charset.forName("US-ASCII"))); // 进行一个加密的处理
			// 在进行授权的头信息内容配置的时候加密的信息一定要与“Basic”之间有一个空格
			String authHeader = "Basic " + new String(encodedAuth);
			currentContext.addZuulRequestHeader("Authorization", authHeader);
			return null;
		}
	
		@Override
		public boolean shouldFilter() {	// 该Filter是否要执行
			return true ;
		}
	
		@Override
		public int filterOrder() {
			return 0;	// 设置优先级，数字越大优先级越低
		}
	
		@Override
		public String filterType() {
			// 在进行Zuul过滤的时候可以设置其过滤执行的位置，那么此时有如下几种类型：
			// 1、pre：在请求发出之前执行过滤，如果要进行访问，肯定在请求前设置头信息
			// 2、route：在进行路由请求的时候被调用；
			// 3、post：在路由之后发送请求信息的时候被调用；
			// 4、error：出现错误之后进行调用
			return "pre";
		}
	
	}







**2.增加security模块**

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-security</artifactId>
        </dependency>


此时的pom文件：

	<?xml version="1.0" encoding="UTF-8"?>
	<project xmlns="http://maven.apache.org/POM/4.0.0"
	         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
	    <parent>
	        <artifactId>microcloud</artifactId>
	        <groupId>com.wzy</groupId>
	        <version>1.0-SNAPSHOT</version>
	    </parent>
	    <modelVersion>4.0.0</modelVersion>
	
	    <artifactId>microcloud-zuul-gateway-9501</artifactId>
	    <name>microcloud-zuul-gateway-9501</name>
	    <url>http://maven.apache.org</url>
	    <properties>
	        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
	    </properties>
	    <dependencies>
	        <dependency>
	            <groupId>org.springframework.boot</groupId>
	            <artifactId>spring-boot-starter-actuator</artifactId>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework.cloud</groupId>
	            <artifactId>spring-cloud-starter-hystrix</artifactId>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework.cloud</groupId>
	            <artifactId>spring-cloud-starter-zuul</artifactId>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework.cloud</groupId>
	            <artifactId>spring-cloud-starter-eureka</artifactId>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework.cloud</groupId>
	            <artifactId>spring-cloud-starter-config</artifactId>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework.boot</groupId>
	            <artifactId>spring-boot-starter-security</artifactId>
	        </dependency>
	        <dependency>
	            <groupId>com.wzy</groupId>
	            <artifactId>mircocloud-api</artifactId>
	            <version>1.0-SNAPSHOT</version>
	            <scope>compile</scope>
	        </dependency>
	        <dependency>
	            <groupId>junit</groupId>
	            <artifactId>junit</artifactId>
	            <scope>test</scope>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework.boot</groupId>
	            <artifactId>spring-boot-starter-jetty</artifactId>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework.boot</groupId>
	            <artifactId>spring-boot-starter-web</artifactId>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework.boot</groupId>
	            <artifactId>spring-boot-starter-test</artifactId>
	            <scope>test</scope>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework</groupId>
	            <artifactId>springloaded</artifactId>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework.boot</groupId>
	            <artifactId>spring-boot-devtools</artifactId>
	        </dependency>
	    </dependencies>
	</project>


**3.修改application.yml**

增加：

	security:
	  basic:
	    enabled: true
	  user:
	    name: zdmin
	    password: mldnjava


此时的application.yml为：

	server:
	  port: 9501
	
	zuul:
	  prefix: /mldn-proxy
	  ignored-services:
	    "*"
	  routes:
	    microcloud-provider-company: /company-proxy/**
	
	eureka:
	  client: # 客户端进行Eureka注册的配置
	    service-url:
	      defaultZone: http://edmin:mldnjava@eureka-7001.com:7001/eureka,http://edmin:mldnjava@eureka-7002.com:7002/eureka,http://edmin:mldnjava@eureka-7003.com:7003/eureka
	  instance:
	    lease-renewal-interval-in-seconds: 2 # 设置心跳的时间间隔（默认是30秒）
	    lease-expiration-duration-in-seconds: 5 # 如果现在超过了5秒的间隔（默认是90秒）
	    instance-id: gateway-9501.com  # 在信息列表时显示主机名称
	    prefer-ip-address: true     # 访问的路径变为IP地址
	
	info:
	  app.name: mldn-microcloud
	  company.name: www.mldn.cn
	  build.artifactId: $project.artifactId$
	  build.version: $project.verson$
	
	spring:
	  application:
	    name: microcloud-zuul-gateway
	
	
	security:
	  basic:
	    enabled: true
	  user:
	    name: zdmin
	    password: mldnjava



**4. 验证**

启动

microcloud-eureka-7001

microcloud-provider-company

microcloud-zuul-gateway-9501


    http://gateway-9501.com:9501/mldn-proxy/company-proxy/company/get/hello


需要输入账号密码：  

  zdmin
 
  mldnjava




**5.Feign修改**

如果启用了Zuul，则同时需要修改Feign相关配置

修改microcloud-service下的IDeptClientService文件

![](../Images/40.png)


原来的代码如下：
	
	package com.wzy;
	
	import java.util.List;
	
	import com.wzy.fallback.IDeptClientServiceFallback;
	import com.wzy.vo.Dept;
	import org.springframework.cloud.netflix.feign.FeignClient;
	import org.springframework.web.bind.annotation.PathVariable;
	import org.springframework.web.bind.annotation.RequestMapping;
	import org.springframework.web.bind.annotation.RequestMethod;
	import com.commons.config.FeignClientConfig;
	
	@FeignClient(value="MICROCLOUD-PROVIDER-DEPT",configuration=FeignClientConfig.class, fallbackFactory = IDeptClientServiceFallback.class)
	public interface IDeptClientService {
	
		@RequestMapping(method=RequestMethod.GET,value="/dept/get/{id}")
		public Dept get(@PathVariable("id") long id) ;
	
		@RequestMapping(method=RequestMethod.GET,value="/dept/list")
		public List<Dept> list() ;
	
		@RequestMapping(method=RequestMethod.POST,value="/dept/add")
		public boolean add(Dept dept) ;
	}
	


修改为：


	package com.wzy;
	
			import java.util.List;
	
			import com.wzy.fallback.IDeptClientServiceFallback;
			import com.wzy.vo.Dept;
			import org.springframework.cloud.netflix.feign.FeignClient;
			import org.springframework.web.bind.annotation.PathVariable;
			import org.springframework.web.bind.annotation.RequestMapping;
			import org.springframework.web.bind.annotation.RequestMethod;
			import com.commons.config.FeignClientConfig;
	
	@FeignClient(value="MICROCLOUD-ZUUL-GATEWAY",configuration=FeignClientConfig.class, fallbackFactory = IDeptClientServiceFallback.class)
	public interface IDeptClientService {
	
		@RequestMapping(method = RequestMethod.GET, value = "/mldn-proxy/dept-proxy/dept/get/{id}")
		public Dept get(@PathVariable("id") long id);
	
		@RequestMapping(method = RequestMethod.GET, value = "/mldn-proxy/dept-proxy/dept/list")
		public List<Dept> list();
	
		@RequestMapping(method = RequestMethod.POST, value = "/mldn-proxy/dept-proxy/dept/add")
		public boolean add(Dept dept);
	}



其中，FeignClient 需要将value替换为zuul注册在eureka之中的名称

@Requestmapping的值也需要替换



**security验证账号密码修改**

FeignClientConfig文件也需要将账号密码验证变为zuul的

原来的代码：


	import org.springframework.context.annotation.Bean;
	import org.springframework.context.annotation.Configuration;
	
	import feign.auth.BasicAuthRequestInterceptor;
	@Configuration
	public class FeignClientConfig {
		@Bean
		public BasicAuthRequestInterceptor getBasicAuthRequestInterceptor() {
			return new BasicAuthRequestInterceptor("mldnjava", "hello");
		}
	}



修改为：

	package com.commons.config;
	
	import org.springframework.context.annotation.Bean;
	import org.springframework.context.annotation.Configuration;
	
	import feign.auth.BasicAuthRequestInterceptor;
	@Configuration
	public class FeignClientConfig {
		@Bean
		public BasicAuthRequestInterceptor getBasicAuthRequestInterceptor() {
			return new BasicAuthRequestInterceptor("zdmin", "mldnjava");
		}
	}





**6.验证**


启动

microcloud-consumer-feign

microcloud-eureka-7001

mircocloud-provider-dept-8001


请求

    http://client.com/consumer/dept/get?id=2


可以成功请求有返回值则表示成功



