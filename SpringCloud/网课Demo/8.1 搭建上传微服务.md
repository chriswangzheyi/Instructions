**搭建上传微服务**


搭建一个用于上传文件的微服务



**1.修改host文件**


C:\Windows\System32\drivers\etc

新增

    127.0.0.1 upload.com


**2. 新增一个module**

microcloud-provider-upload-8201


![](../Images/42.png)


---

**UploadRest:**

    package com.wzy.rest;
    
    import org.springframework.web.bind.annotation.RequestMapping;
    import org.springframework.web.bind.annotation.RequestMethod;
    import org.springframework.web.bind.annotation.RequestParam;
    import org.springframework.web.bind.annotation.RestController;
    import org.springframework.web.multipart.MultipartFile;
    
    import com.netflix.hystrix.contrib.javanica.annotation.HystrixCommand;
    
    @RestController
    public class UploadRest {
    	@RequestMapping(value = "/upload", method = RequestMethod.POST)
    	@HystrixCommand(fallbackMethod="uploadFallback")
    	public String upload(@RequestParam("photo") MultipartFile photo) {
    		if (photo != null) {	// 表示现在已经有文件上传了
    			System.out.println("【*** UploadRest ***】文件名称："
    					+ photo.getOriginalFilename() + "、文件大小：" + photo.getSize());
    		}
    		return "mldn-file-" + System.currentTimeMillis() + ".jpg" ;
    	}
    	public String uploadFallback(@RequestParam("photo") MultipartFile photo) {
    		return "nophoto.jpg" ;
    	}
    }
    



**Upload_8201_StartSpringCloudApplication:**

	package com.wzy;
	
	import org.springframework.boot.SpringApplication;
	import org.springframework.boot.autoconfigure.SpringBootApplication;
	import org.springframework.cloud.client.circuitbreaker.EnableCircuitBreaker;
	import org.springframework.cloud.client.discovery.EnableDiscoveryClient;
	import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
	@SpringBootApplication
	@EnableEurekaClient
	@EnableCircuitBreaker
	@EnableDiscoveryClient
	public class Upload_8201_StartSpringCloudApplication {
		public static void main(String[] args) {
			SpringApplication.run(Upload_8201_StartSpringCloudApplication.class, args);
		}
	}



**application.yml:**

	server:
	  port: 8201
	spring: 
	  http:
	    multipart:
	      enabled: true   # 启用http上传处理
	      max-file-size: 100MB # 设置单个文件的最大长度
	      max-request-size: 100MB # 设置最大的请求文件的大小
	      file-size-threshold: 1MB  # 当上传文件达到1MB的时候进行磁盘写入
	      location: /  # 上传的临时目录
	  application: 
	    name: microcloud-provider-upload
	
	eureka:
	  client: # 客户端进行Eureka注册的配置
	    service-url:
	      defaultZone: http://edmin:mldnjava@eureka-7001.com:7001/eureka,http://edmin:mldnjava@eureka-7002.com:7002/eureka,http://edmin:mldnjava@eureka-7003.com:7003/eureka
	  instance:
	    lease-renewal-interval-in-seconds: 2 # 设置心跳的时间间隔（默认是30秒）
	    lease-expiration-duration-in-seconds: 5 # 如果现在超过了5秒的间隔（默认是90秒）
	    instance-id: dept-8001.com  # 在信息列表时显示主机名称
	    prefer-ip-address: true     # 访问的路径变为IP地址
	
	info:
	  app.name: mldn-microcloud
	  company.name: www.mldn.cn
	  build.artifactId: $project.artifactId$
	  build.version: $project.verson$





**3. 验证：**

使用Postman 请求：

![](../Images/43.png)


mldnjava:hello@upload.com:8201/upload


该错误信息表示，该微服务需要跨站。



**4.去掉CSRF的限制**


microcloud-security 项目中： 修改WebSecurityConfig文件：


---原来的WebSecurityConfig：


	
	package com.wzy.config;
	
	import javax.annotation.Resource;
	import org.springframework.context.annotation.Configuration;
	import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
	import org.springframework.security.config.annotation.web.builders.HttpSecurity;
	import org.springframework.security.config.annotation.web.builders.WebSecurity;
	import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
	import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
	import org.springframework.security.config.http.SessionCreationPolicy;
	@Configuration
	@EnableWebSecurity
	public class WebSecurityConfig extends WebSecurityConfigurerAdapter {
		@Resource
		public void configGlobal(AuthenticationManagerBuilder auth)
				throws Exception {
			auth.inMemoryAuthentication().withUser("mldnjava").password("hello")
					.roles("USER").and().withUser("admin").password("hello")
					.roles("USER", "ADMIN");
		}
		@Override
		protected void configure(HttpSecurity http) throws Exception {
			// 表示所有的访问都必须进行认证处理后才可以正常进行
			http.httpBasic().and().authorizeRequests().anyRequest()
					.fullyAuthenticated();
			// 所有的Rest服务一定要设置为无状态，以提升操作性能
			http.sessionManagement()
					.sessionCreationPolicy(SessionCreationPolicy.STATELESS);
		}
	
		@Override
		public void configure(WebSecurity web) throws Exception {
			web.ignoring().antMatchers("/hystrix.stream","/turbine.stream") ;
		}
	
	}



将http.httpBasic().and().authorizeRequests().anyRequest().fullyAuthenticated(); 修改为：**http.httpBasic().and().authorizeRequests().anyRequest().fullyAuthenticated().and().csrf().disable();**


修改后的WebSecurityConfig文件：


	package com.wzy.config;
	
	import javax.annotation.Resource;
	import org.springframework.context.annotation.Configuration;
	import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
	import org.springframework.security.config.annotation.web.builders.HttpSecurity;
	import org.springframework.security.config.annotation.web.builders.WebSecurity;
	import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
	import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
	import org.springframework.security.config.http.SessionCreationPolicy;
	@Configuration
	@EnableWebSecurity
	public class WebSecurityConfig extends WebSecurityConfigurerAdapter {
		@Resource
		public void configGlobal(AuthenticationManagerBuilder auth)
				throws Exception {
			auth.inMemoryAuthentication().withUser("mldnjava").password("hello")
					.roles("USER").and().withUser("admin").password("hello")
					.roles("USER", "ADMIN");
		}
		@Override
		protected void configure(HttpSecurity http) throws Exception {
			// 表示所有的访问都必须进行认证处理后才可以正常进行
			http.httpBasic().and().authorizeRequests().anyRequest()
					.fullyAuthenticated().and().csrf().disable();
			// 所有的Rest服务一定要设置为无状态，以提升操作性能
			http.sessionManagement()
					.sessionCreationPolicy(SessionCreationPolicy.STATELESS);
		}
	
		@Override
		public void configure(WebSecurity web) throws Exception {
			web.ignoring().antMatchers("/hystrix.stream","/turbine.stream") ;
		}
	}



此时已经取消了对csdf的验证


**5.再验证**

重新启动microcloud-provider-upload-8201 项目后：

再次用postman模拟请求：


Postman的内容：

![](../Images/44.png)


---

打印出来的内容：

![](../Images/45.png)