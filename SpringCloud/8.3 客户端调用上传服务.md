**客户端调用上传服务**




**1.修改Host**

    127.0.0.1 consumer-upload.com


**2.新建一个module**

microcloud-consumer-upload


![](../Images/46.png)


---

**ConsumerUploadController:**

	package com.wzy.controller;
	
	import java.nio.charset.Charset;
	
	import org.apache.http.HttpEntity;
	import org.apache.http.HttpResponse;
	import org.apache.http.auth.AuthScope;
	import org.apache.http.auth.Credentials;
	import org.apache.http.auth.UsernamePasswordCredentials;
	import org.apache.http.client.CredentialsProvider;
	import org.apache.http.client.methods.HttpPost;
	import org.apache.http.client.protocol.HttpClientContext;
	import org.apache.http.entity.ContentType;
	import org.apache.http.entity.mime.MultipartEntityBuilder;
	import org.apache.http.impl.client.BasicCredentialsProvider;
	import org.apache.http.impl.client.CloseableHttpClient;
	import org.apache.http.impl.client.HttpClients;
	import org.apache.http.util.EntityUtils;
	import org.springframework.stereotype.Controller;
	import org.springframework.web.bind.annotation.RequestMapping;
	import org.springframework.web.bind.annotation.RequestMethod;
	import org.springframework.web.bind.annotation.ResponseBody;
	import org.springframework.web.multipart.MultipartFile;
	
	@Controller
	public class ConsumerUploadController {
		// 设置要进行远程上传微服务调用的代理地址
		public static final String UPLOAD_URL = "http://gateway-9501.com:9501/zuul/mldn-proxy/upload-proxy/upload";
	
		/*跳转页面*/
		@RequestMapping(value = "/consumer/uploadPre", method = RequestMethod.GET)
		public String uploadPre() {
			return "upload";
		}
	
		/*上传文件*/
		@RequestMapping(value = "/consumer/upload", method = RequestMethod.POST)
		public @ResponseBody String upload(String name, MultipartFile photo) throws Exception {
			if (photo != null) {
				CloseableHttpClient httpClient = HttpClients.createDefault(); // 创建一个HttpClient对象
				CredentialsProvider credsProvider = new BasicCredentialsProvider(); // 创建了一个具有认证访问的信息
				Credentials credentials = new UsernamePasswordCredentials("zdmin",
						"mldnjava"); // 创建一条认证操作信息
				credsProvider.setCredentials(AuthScope.ANY, credentials); // 现在所有的认证请求都使用一个认证信息
				HttpClientContext httpContext = HttpClientContext.create(); // 创建Http处理操作的上下文对象
				httpContext.setCredentialsProvider(credsProvider);// 设置认证的提供信息
				HttpPost httpPost = new HttpPost(UPLOAD_URL); // 设置要进行访问的请求地址
				HttpEntity entity = MultipartEntityBuilder.create()
						.addBinaryBody("photo", photo.getBytes(),
								ContentType.create("image/jpeg"), "temp.jpg")
						.build();
				httpPost.setEntity(entity);	// 将请求的实体信息进行发送
				HttpResponse response = httpClient.execute(httpPost, httpContext) ;	// 执行请求的发送
				return EntityUtils.toString(response.getEntity(),Charset.forName("UTF-8")) ;
	//			return "【*** 消费端 ***】name = " + name + "、photoName = "
	//					+ photo.getOriginalFilename() + "、ContentType = "
	//					+ photo.getContentType();
			}
			return "nophoto.jpg";
		}
	}




**Consumer_80_StartSpringCloudApplication:**


	package com.wzy;
	
	import org.springframework.boot.SpringApplication;
	import org.springframework.boot.autoconfigure.SpringBootApplication;
	import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
	import org.springframework.cloud.netflix.feign.EnableFeignClients;
	@SpringBootApplication
	@EnableEurekaClient
	@EnableFeignClients(basePackages={"com.wzy"})
	public class Consumer_80_StartSpringCloudApplication {
		public static void main(String[] args) {
			SpringApplication.run(Consumer_80_StartSpringCloudApplication.class,
					args);
		}
	}



**upload.html:**

	
	<!DOCTYPE HTML>
	<html xmlns:th="http://www.thymeleaf.org">
	<head>
	<title>SpringCloud微服务</title>
	<link rel="icon" type="image/x-icon" href="/images/mldn.ico" />
	<meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
	</head>
	<body>
		<form th:action="@{/consumer/upload}" method="post" enctype="multipart/form-data">
			姓名：<input type="text" name="name" id="name" value="MLDN"/><br/>
			照片：<input type="file" name="photo" id="photo"/><br/> 
			<input type="submit" value="提交"/>
			<input type="reset" value="重置"/>
		</form>
	</body>
	</html>



**application.yml:**

	server:
	  port: 80
	eureka:
	  client: # 客户端进行Eureka注册的配置
	    register-with-eureka: false # 不在eureka之中进行注册
	    service-url:
	      defaultZone: http://edmin:mldnjava@eureka-7001.com:7001/eureka,http://edmin:mldnjava@eureka-7002.com:7002/eureka,http://edmin:mldnjava@eureka-7003.com:7003/eureka
	  instance:
	    lease-renewal-interval-in-seconds: 2 # 设置心跳的时间间隔（默认是30秒）
	    lease-expiration-duration-in-seconds: 5 # 如果现在超过了5秒的间隔（默认是90秒）
	    instance-id: upload.com  # 在信息列表时显示主机名称
	    prefer-ip-address: true     # 访问的路径变为IP地址



**pom.xml:**

	<?xml version="1.0" encoding="UTF-8"?>
	<project xmlns="http://maven.apache.org/POM/4.0.0"
	         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
	    <parent>
	        <artifactId>microcloud</artifactId>
	        <groupId>com.wzy</groupId>
	        <version>1.0-SNAPSHOT</version>
	    </parent>
	    <modelVersion>4.0.0</modelVersion>
	
	    <artifactId>microcloud-consumer-upload</artifactId>
	    <name>microcloud-consumer-upload</name>
	    <url>http://maven.apache.org</url>
	    <properties>
	        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
	    </properties>
	    <dependencies>
	
	        <dependency>
	            <groupId>org.apache.httpcomponents</groupId>
	            <artifactId>httpclient</artifactId>
	        </dependency>
	        <dependency>
	            <groupId>org.apache.httpcomponents</groupId>
	            <artifactId>httpmime</artifactId>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework.boot</groupId>
	            <artifactId>spring-boot-starter-thymeleaf</artifactId>
	        </dependency>
	
	
	        <dependency>
	            <groupId>org.springframework.cloud</groupId>
	            <artifactId>spring-cloud-starter-feign</artifactId>
	        </dependency>
	
	
	        <dependency>
	            <groupId>org.springframework.cloud</groupId>
	            <artifactId>spring-cloud-starter-eureka</artifactId>
	        </dependency>
	
	        <dependency>
	            <groupId>org.springframework.cloud</groupId>
	            <artifactId>spring-cloud-starter-config</artifactId>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework.cloud</groupId>
	            <artifactId>spring-cloud-starter-ribbon</artifactId>
	        </dependency>
	
	        <dependency>
	            <groupId>com.wzy</groupId>
	            <artifactId>mircocloud-api</artifactId>
	            <version>1.0-SNAPSHOT</version>
	            <scope>compile</scope>
	        </dependency>
	        <dependency>
	            <groupId>com.wzy</groupId>
	            <artifactId>microcloud-service</artifactId>
	            <version>1.0-SNAPSHOT</version>
	        </dependency>
	        <dependency>
	            <groupId>junit</groupId>
	            <artifactId>junit</artifactId>
	            <scope>test</scope>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework.boot</groupId>
	            <artifactId>spring-boot-starter-jetty</artifactId>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework.boot</groupId>
	            <artifactId>spring-boot-starter-web</artifactId>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework.boot</groupId>
	            <artifactId>spring-boot-starter-test</artifactId>
	            <scope>test</scope>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework</groupId>
	            <artifactId>springloaded</artifactId>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework.boot</groupId>
	            <artifactId>spring-boot-devtools</artifactId>
	        </dependency>
	    </dependencies>
	</project>




**3.验证**

访问：

    http://consumer-upload.com/consumer/uploadPre