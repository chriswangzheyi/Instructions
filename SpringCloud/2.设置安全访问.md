**SpringSecurity安全认证**


一般首先在服务的提供方上进行安全认证。以Demo为例子。

mircocloud-provider-dept-8001项目中：


 **1.Pom文件添加依赖**

		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-security</artifactId>
		</dependency>



 **2.在application.yml中增加配置项**

    security:
      basic:
    	enabled: true # 启用SpringSecurity的安全配置项
      user:
    	name: mldnjava  # 认证用户名
    	password: hello # 认证密码
    	role:# 授权角色
    	- USER


 **3.验证是否生效**


启动mircocloud-provider-dept-8001 项目，

访问   

    http://dept-8001.com:8001/dept/get/4

此时弹出账号密码框

![](../Images/6.png)


输入账号mldnjava, 密码hello 即可访问。


简化请求url为   
	http:【账号】:【密码】@访问地址

    http://mldnjava:hello@dept-8001.com:8001/dept/get/4


**但是该请求方法不能应用在消费端的请求中**。


   
---



microcloud-consumer-80：


 **1.在Restconfig.java文件中增加一个bean：**


    	@Bean
    	public HttpHeaders getHeaders() { // 要进行一个Http头信息配置
    		HttpHeaders headers = new HttpHeaders(); // 定义一个HTTP的头信息
    		String auth = "mldnjava:hello"; // 认证的原始信息
    		byte[] encodedAuth = Base64.getEncoder()
    				.encode(auth.getBytes(Charset.forName("US-ASCII"))); // 进行一个加密的处理
    		// 在进行授权的头信息内容配置的时候加密的信息一定要与“Basic”之间有一个空格
    		String authHeader = "Basic " + new String(encodedAuth);
    		headers.set("Authorization", authHeader);
    		return headers;
    	}



  **2.ConsumerDeptController 中新增：**


    	@Resource
    	private HttpHeaders headers;




  **3.用template.exchange重写请求，将header传入：**

此时的controller文件如下：

		import java.util.List;
		import javax.annotation.Resource;
		import com.wzy.vo.Dept;
		import org.springframework.http.HttpEntity;
		import org.springframework.http.HttpHeaders;
		import org.springframework.http.HttpMethod;
		import org.springframework.web.bind.annotation.RequestMapping;
		import org.springframework.web.bind.annotation.RestController;
		import org.springframework.web.client.RestTemplate;
		
		
		
		@RestController
		public class ConsumerDeptController {
		
		
		    public static final String DEPT_GET_URL = "http://dept-8001.com:8001/dept/get/";
		    public static final String DEPT_LIST_URL = "http://dept-8001.com:8001/dept/list/";
		    public static final String DEPT_ADD_URL = "http://dept-8001.com:8001/dept/add?dname=";
		
		    @Resource
		    private RestTemplate restTemplate;
		    @Resource
		    private HttpHeaders headers;
		
		
		    @RequestMapping(value = "/consumer/dept/get")
		    public Object getDept(long id) {
		        Dept dept = this.restTemplate
		                .exchange(DEPT_GET_URL + id, HttpMethod.GET,
		                        new HttpEntity<Object>(this.headers), Dept.class)
		                .getBody();
		        return dept;
		    }


		    @SuppressWarnings("unchecked")
		    @RequestMapping(value = "/consumer/dept/list")
		    public Object listDept() {
		        List<Dept> allDepts = this.restTemplate
		                .exchange(DEPT_LIST_URL, HttpMethod.GET,
		                        new HttpEntity<Object>(this.headers), List.class)
		                .getBody();
		        return allDepts;
		    }


		    @RequestMapping(value = "/consumer/dept/add")
		    public Object addDept(Dept dept) throws Exception {
		        Boolean flag = this.restTemplate.exchange(DEPT_ADD_URL, HttpMethod.POST,
		                new HttpEntity<Object>(dept, this.headers), Boolean.class)
		                .getBody();
		        return flag;
		    }
		}





 **4.重启 mircocloud-provider-dept-8001 和 microcloud-consumer-80 服务**


**5.验证**

访问：
    
		http://client.com/consumer/dept/list


得到反馈：

    [{"deptno":2,"dname":"开发部","loc":"mldn8001"},{"deptno":3,"dname":"财务部","loc":"mldn8001"},{"deptno":4,"dname":"后勤部","loc":"mldn8001"},{"deptno":5,"dname":"市场部","loc":"mldn8001"},{"deptno":6,"dname":"公关部","loc":"mldn8001"}]


证明消费端的账号密码发送至提供端验证成功。


-------------------


**配置安全模块**

前面提到的方法比较麻烦，不太适合接口较多的情况，所以用安全模块替代。



 **1.创建microcloud-security模块**



![](../Images/7.png)



  **2.POM文件**

	<?xml version="1.0" encoding="UTF-8"?>
	<project xmlns="http://maven.apache.org/POM/4.0.0"
	         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
	    <parent>
	        <artifactId>microcloud</artifactId>
	        <groupId>com.wzy</groupId>
	        <version>1.0-SNAPSHOT</version>
	    </parent>
	    <modelVersion>4.0.0</modelVersion>
	
	    <artifactId>microcloud-security</artifactId>
	    <name>microcloud-security</name>
	    <url>http://maven.apache.org</url>
	    <properties>
	        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
	    </properties>
	    <dependencies>
	        <dependency>
	            <groupId>org.springframework.boot</groupId>
	            <artifactId>spring-boot-starter-web</artifactId>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework.boot</groupId>
	            <artifactId>spring-boot-starter-security</artifactId>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework</groupId>
	            <artifactId>springloaded</artifactId>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework.boot</groupId>
	            <artifactId>spring-boot-devtools</artifactId>
	        </dependency>
	    </dependencies>
	</project>




**3.WebSecurityConfig:**


	import javax.annotation.Resource;
	import org.springframework.context.annotation.Configuration;
	import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
	import org.springframework.security.config.annotation.web.builders.HttpSecurity;
	import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
	import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
	import org.springframework.security.config.http.SessionCreationPolicy;
	@Configuration
	@EnableWebSecurity
	public class WebSecurityConfig extends WebSecurityConfigurerAdapter {
		@Resource
		public void configGlobal(AuthenticationManagerBuilder auth)
				throws Exception {
			auth.inMemoryAuthentication().withUser("mldnjava").password("hello")
					.roles("USER").and().withUser("admin").password("hello")
					.roles("USER", "ADMIN");
		}
		@Override
		protected void configure(HttpSecurity http) throws Exception {
			// 表示所有的访问都必须进行认证处理后才可以正常进行
			http.httpBasic().and().authorizeRequests().anyRequest()
					.fullyAuthenticated();
			// 所有的Rest服务一定要设置为无状态，以提升操作性能
			http.sessionManagement()
					.sessionCreationPolicy(SessionCreationPolicy.STATELESS);
		}
	}



**4.添加项目到对应的项目中(例如 mircocloud-provider-dept-8001)**


pom文件中引用microcloud-security

        <dependency>
            <groupId>com.wzy</groupId>
            <artifactId>microcloud-security</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>



可以删除（替代）原来配置文件的以下内容：

	
		security:
		  basic:
		    enabled: true # 启用SpringSecurity的安全配置项
		  user:
		    name: mldnjava  # 认证用户名
		    password: hello # 认证密码
		    role:        # 授权角色
		    - USER


