**自定义Ribbon**


**1.增加自定义类：**

microcloud-consumer-80:

新增一个loadbalance配置类，该配置类应该放到Springcloud启动后找不到的地方，让componentScan找不到的地方。


新增一个package:com.commons.config, 增加MyLoadBalanceConfig类

![](../Images/22.png)



MyLoadBalanceConfig:

	import org.springframework.context.annotation.Bean;
	import com.netflix.loadbalancer.IRule;
	
	public class MyLoadBalanceConfig {
		@Bean
		public IRule ribbonRule() { // 其中IRule就是所有规则的标准
			return new com.netflix.loadbalancer.RandomRule() ;
		}
	}


IRule就是所有规则的标准：

**com.netflix.loadbalancer.RoundRobinRule：**   
该策略实现按照线性轮询的方式依次选择实例的功能。它的具体实现如下，在循环中增加了一个count计数变量，该变量会在每次轮询之后累加，如果轮询次数Server超过10次，选择不到实例的话，会报警告信息。

**com.netflix.loadbalancer.RetryRule：**   
该策略实现了一个具备重试机制的实例选择功能。具有RoundRobinRule实例的一个引用。也就是在一段时间内通过RoundRobinRule选择服务实例，一段时间内没有选择出服务则线程终止。


**com.netflix.loadbalancer.WeightedResponseTimeRule：**   
该策略是对RoundRobinRule的扩展，增加了根据实例的运行情况来计算权重，并根据权重来挑选实例，以达到更优的分配效果，增加了三个核心的内容：

会在启动的时候启动一个定时任务，去计算每个实例的权重，默认30s执行一次


**com.netflix.loadbalancer.BestAvailableRule：**   
该策略继承ClientConfigEnabledRoundRobinRule，在实现中它注入了负载均衡的统计对象LoadBalancerStats，同时在具体的choose算法中利用LoadBalancerStats保存的实例统计信息来选择满足要求的实例。它通过遍历负载均衡器中的维护的所有实例，会过滤掉故障的实例，并找出并发请求数最小的一个，所以该策略的特性时可选出最空闲的实例。


> 参考资料：https://www.jianshu.com/p/186b4ceea6fc


----

**2.修改程序主类**

Consumer_80_StartSpringCloudApplication：

	
	import com.commons.config.MyLoadBalanceConfig;
	import org.springframework.boot.SpringApplication;
	import org.springframework.boot.autoconfigure.SpringBootApplication;
	import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
	import org.springframework.cloud.netflix.ribbon.RibbonClient;
	
	@SpringBootApplication
	@EnableEurekaClient
	@RibbonClient(name = "ribbon",configuration = MyLoadBalanceConfig.class)
	public class Consumer_80_StartSpringCloudApplication {
		public static void main(String[] args) {
			SpringApplication.run(Consumer_80_StartSpringCloudApplication.class,
					args);
		}
	}



@RibbonClient注解中，新增两个属性：   
name: 随意取名   
configuration:自定义类