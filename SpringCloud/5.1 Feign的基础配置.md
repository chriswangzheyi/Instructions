**Feign**

**1.Feign简介**

在Spring cloud 中服务之间通过restful方式调用有两种方式 

- restTemplate+Ribbon 
- feign


feign的开发包中自带了Ribbon。  
feign可以简化restTemplate+Ribbon的头信息相关代码。



**2.搭建服务**   

新建一个modlue:

**microcloud-consumer-feign**

![](../Images/23.png)


**MyLoadBalanceConfig:**

	import org.springframework.context.annotation.Bean;
	
	import com.netflix.loadbalancer.IRule;
	
	public class MyLoadBalanceConfig {
		@Bean
		public IRule ribbonRule() { // 其中IRule就是所有规则的标准
			return new com.netflix.loadbalancer.RandomRule() ;
		}
	}


该文件设置了provider负载均衡策略，不作为feign的必须项。



**FeignClientConfig**

	import org.springframework.context.annotation.Bean;
	import org.springframework.context.annotation.Configuration;
	import feign.auth.BasicAuthRequestInterceptor;

	@Configuration
	public class FeignClientConfig {

		@Bean
		public BasicAuthRequestInterceptor getBasicAuthRequestInterceptor() {
			return new BasicAuthRequestInterceptor("mldnjava", "hello");
		}
	}


简化了Resttemplate相关的请求头代码。

BasicAuthRequestInterceptor后跟的参数为Provider的请求账号密码。




**ConsumerDeptController**

	
	import javax.annotation.Resource;
	import com.wzy.IDeptClientService;
	import org.springframework.web.bind.annotation.RequestMapping;
	import org.springframework.web.bind.annotation.RestController;
	import com.wzy.vo.Dept;
	
	@RestController
	public class ConsumerDeptController {
	
		@Resource
		private IDeptClientService deptService ;
	
		@RequestMapping(value = "/consumer/dept/get")
		public Object getDept(long id) {
			return this.deptService.get(id);
		}
	
		@RequestMapping(value = "/consumer/dept/list")
		public Object listDept() {
			return this.deptService.list();
		}
	
		@RequestMapping(value = "/consumer/dept/add")
		public Object addDept(Dept dept) throws Exception {
			return this.deptService.add(dept);
		}
	}



其中， IDeptClientService为microcloud-service项目中的接口



**Consumer_80_StartSpringCloudApplication**



	import org.springframework.boot.SpringApplication;
	import org.springframework.boot.autoconfigure.SpringBootApplication;
	import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
	import org.springframework.cloud.netflix.feign.EnableFeignClients;
	@SpringBootApplication
	@EnableEurekaClient
	
	@EnableFeignClients(basePackages={"com.wzy"})
	public class Consumer_80_StartSpringCloudApplication {
		public static void main(String[] args) {
			SpringApplication.run(Consumer_80_StartSpringCloudApplication.class,
					args);
		}
	}


**注意：@EnableFeignClients(basePackages={"com.wzy"})需要扫描microcloud-service项目的接口类所在package。**

	
---

**application.yml：**


	server:
	  port: 80
	
	eureka: 
	  client: 
	    register-with-eureka: false
	    service-url: 
	      defaultZone: http://edmin:mldnjava@eureka-7001.com:7001/eureka,http://edmin:mldnjava@eureka-7002.com:7002/eureka,http://edmin:mldnjava@eureka-7003.com:7003/eureka
	


**pom:**


	<?xml version="1.0" encoding="UTF-8"?>
	<project xmlns="http://maven.apache.org/POM/4.0.0"
	         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
	    <parent>
	        <artifactId>microcloud</artifactId>
	        <groupId>com.wzy</groupId>
	        <version>1.0-SNAPSHOT</version>
	    </parent>
	    <modelVersion>4.0.0</modelVersion>
	
	    <artifactId>microcloud-consumer-feign</artifactId>
	    <name>microcloud-consumer-feign</name>
	    <url>http://maven.apache.org</url>
	    <properties>
	        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
	    </properties>
	    <dependencies>
	        <dependency>
	            <groupId>org.springframework.cloud</groupId>
	            <artifactId>spring-cloud-starter-feign</artifactId>
	        </dependency>
	
	
	        <dependency>
	            <groupId>org.springframework.cloud</groupId>
	            <artifactId>spring-cloud-starter-eureka</artifactId>
	        </dependency>
	
	        <dependency>
	            <groupId>org.springframework.cloud</groupId>
	            <artifactId>spring-cloud-starter-config</artifactId>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework.cloud</groupId>
	            <artifactId>spring-cloud-starter-ribbon</artifactId>
	        </dependency>
	
	        <dependency>
	            <groupId>com.wzy</groupId>
	            <artifactId>mircocloud-api</artifactId>
	            <version>1.0-SNAPSHOT</version>
	            <scope>compile</scope>
	        </dependency>
	        <dependency>
	            <groupId>com.wzy</groupId>
	            <artifactId>microcloud-service</artifactId>
	            <version>1.0-SNAPSHOT</version>
	        </dependency>
	        <dependency>
	            <groupId>junit</groupId>
	            <artifactId>junit</artifactId>
	            <scope>test</scope>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework.boot</groupId>
	            <artifactId>spring-boot-starter-jetty</artifactId>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework.boot</groupId>
	            <artifactId>spring-boot-starter-web</artifactId>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework.boot</groupId>
	            <artifactId>spring-boot-starter-test</artifactId>
	            <scope>test</scope>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework</groupId>
	            <artifactId>springloaded</artifactId>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework.boot</groupId>
	            <artifactId>spring-boot-devtools</artifactId>
	        </dependency>
	    </dependencies>
	</project>








---

新增一个Module:  
**microcloud-service:**


![](../Images/24.png)


**FeignClientConfig**

	import org.springframework.context.annotation.Bean;
	import org.springframework.context.annotation.Configuration;
	import feign.auth.BasicAuthRequestInterceptor;

	@Configuration
	public class FeignClientConfig {
		@Bean
		public BasicAuthRequestInterceptor getBasicAuthRequestInterceptor() {
			return new BasicAuthRequestInterceptor("mldnjava", "hello");
		}
	}



**IDeptClientService:**

	
	import java.util.List;
	import com.wzy.vo.Dept;
	import org.springframework.cloud.netflix.feign.FeignClient;
	import org.springframework.web.bind.annotation.PathVariable;
	import org.springframework.web.bind.annotation.RequestMapping;
	import org.springframework.web.bind.annotation.RequestMethod;
	import com.commons.config.FeignClientConfig;
	
	@FeignClient(value="MICROCLOUD-PROVIDER-DEPT",configuration=FeignClientConfig.class)
	public interface IDeptClientService {
	
		@RequestMapping(method=RequestMethod.GET,value="/dept/get/{id}")
		public Dept get(@PathVariable("id") long id) ;
	
		@RequestMapping(method=RequestMethod.GET,value="/dept/list")
		public List<Dept> list() ;
	
		@RequestMapping(method=RequestMethod.POST,value="/dept/add")
		public boolean add(Dept dept) ;
	}




@FeignClient(value="MICROCLOUD-PROVIDER-DEPT",configuration=FeignClientConfig.class)    

- value为在Eureka中的服务器名
   


@RequestMapping后跟的value属性 为请求provider的url。需要跟provider的controller中的接受请求的url一致。



---

**consumer：**

![](../Images/25.png)


**provider:**

![](../Images/26.png)


---



pom:
	
	<?xml version="1.0" encoding="UTF-8"?>
	<project xmlns="http://maven.apache.org/POM/4.0.0"
	         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
	    <parent>
	        <artifactId>microcloud</artifactId>
	        <groupId>com.wzy</groupId>
	        <version>1.0-SNAPSHOT</version>
	    </parent>
	    <modelVersion>4.0.0</modelVersion>
	    <artifactId>microcloud-service</artifactId>
	    <name>microcloud-service</name>
	    <url>http://maven.apache.org</url>
	    <properties>
	        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
	    </properties>
	    <dependencies>
	        <dependency>
	            <groupId>org.springframework.cloud</groupId>
	            <artifactId>spring-cloud-starter-feign</artifactId>
	        </dependency>
	        <dependency>
	            <groupId>com.wzy</groupId>
	            <artifactId>mircocloud-api</artifactId>
	            <version>1.0-SNAPSHOT</version>
	            <scope>compile</scope>
	        </dependency>
	        <dependency>
	            <groupId>junit</groupId>
	            <artifactId>junit</artifactId>
	            <scope>test</scope>
	        </dependency>
	    </dependencies>
	</project>



**3. 验证：**

启动microcloud-consumer-feign， microcloud-eureka-7001， mircocloud-provider-dept-8001，


访问

    http://client.com/consumer/dept/list


得到：
	
	[{"deptno":2,"dname":"开发部","loc":"mldn8001"},{"deptno":3,"dname":"财务部","loc":"mldn8001"},{"deptno":4,"dname":"后勤部","loc":"mldn8001"},{"deptno":5,"dname":"市场部","loc":"mldn8001"},{"deptno":6,"dname":"公关部","loc":"mldn8001"}]