**Turbine 聚合监控**

HystrixDashboard主要的功能是针对某一项微服务进行监控。但是如果说现在有许多微服务的情况，就可以利用trubine技术实现。



**1.修改vo类**

**mircocloud-api**：

增加Company:

![](../Images/32.png)


Company：
	
	
	import java.io.Serializable;
	
	@SuppressWarnings("serial")
	public class Company implements Serializable {
	    private String title ;
	    private String note ;
	    public String getTitle() {
	        return title;
	    }
	    public void setTitle(String title) {
	        this.title = title;
	    }
	    public String getNote() {
	        return note;
	    }
	    public void setNote(String note) {
	        this.note = note;
	    }
	    @Override
	    public String toString() {
	        return "Company [title=" + title + ", note=" + note + "]";
	    }
	}







**2.搭建模拟provider**

新建microcloud-provider-company，

复制microcloud-provider-hystrix-8001相关内容，但是删除掉pom文件中跟安全相关，数据库连接的依赖：


	
	<?xml version="1.0" encoding="UTF-8"?>
	<project xmlns="http://maven.apache.org/POM/4.0.0"
	         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
	    <parent>
	        <artifactId>microcloud</artifactId>
	        <groupId>com.wzy</groupId>
	        <version>1.0-SNAPSHOT</version>
	    </parent>
	    <modelVersion>4.0.0</modelVersion>
	
	    <artifactId>microcloud-provider-company</artifactId>
	    <name>microcloud-provider-company</name>
	    <url>http://maven.apache.org</url>
	    <properties>
	        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
	    </properties>
	    <dependencies>
	        <dependency>
	            <groupId>org.springframework.boot</groupId>
	            <artifactId>spring-boot-starter-actuator</artifactId>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework.cloud</groupId>
	            <artifactId>spring-cloud-starter-hystrix</artifactId>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework.cloud</groupId>
	            <artifactId>spring-cloud-starter-eureka</artifactId>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework.cloud</groupId>
	            <artifactId>spring-cloud-starter-config</artifactId>
	        </dependency>
	        <dependency>
	            <groupId>com.wzy</groupId>
	            <artifactId>mircocloud-api</artifactId>
	            <version>1.0-SNAPSHOT</version>
	            <scope>compile</scope>
	        </dependency>
	        <dependency>
	            <groupId>junit</groupId>
	            <artifactId>junit</artifactId>
	            <scope>test</scope>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework.boot</groupId>
	            <artifactId>spring-boot-starter-jetty</artifactId>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework.boot</groupId>
	            <artifactId>spring-boot-starter-web</artifactId>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework.boot</groupId>
	            <artifactId>spring-boot-starter-test</artifactId>
	            <scope>test</scope>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework</groupId>
	            <artifactId>springloaded</artifactId>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework.boot</groupId>
	            <artifactId>spring-boot-devtools</artifactId>
	        </dependency>
	    </dependencies>
	</project>




**CompanyRest：**
	
	import com.wzy.vo.Company;
	import org.springframework.web.bind.annotation.PathVariable;
	import org.springframework.web.bind.annotation.RequestMapping;
	import org.springframework.web.bind.annotation.RequestMethod;
	import org.springframework.web.bind.annotation.RestController;
	import com.netflix.hystrix.contrib.javanica.annotation.HystrixCommand;
	
	@RestController
	public class CompanyRest {
		@RequestMapping(value = "/company/get/{title}", method = RequestMethod.GET)
		@HystrixCommand	// 如果需要进行性能监控，那么必须要有此注解
		public Object get(@PathVariable("title") String title) {
			Company vo = new Company() ;
			vo.setTitle(title);
			vo.setNote("www.mldn.cn");
			return vo ;
		}
	}



注意：必须要有@HystrixCommand 注解才能进行性能监控。

---

**Company_8101_StartSpringCloudApplication**

	import org.springframework.boot.SpringApplication;
	import org.springframework.boot.autoconfigure.SpringBootApplication;
	import org.springframework.cloud.client.circuitbreaker.EnableCircuitBreaker;
	import org.springframework.cloud.client.discovery.EnableDiscoveryClient;
	import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
	@SpringBootApplication
	@EnableEurekaClient
	@EnableCircuitBreaker
	@EnableDiscoveryClient
	public class Company_8101_StartSpringCloudApplication {
		public static void main(String[] args) {
			SpringApplication.run(Company_8101_StartSpringCloudApplication.class, args);
		}
	}


需要加上@EnableCircuitBreaker注解


---

**application.yml：**

	server:
	  port: 8101
	
	eureka: 
	  client: # 客户端进行Eureka注册的配置
	    service-url:
	      defaultZone: http://edmin:mldnjava@eureka-7001.com:7001/eureka,http://edmin:mldnjava@eureka-7002.com:7002/eureka,http://edmin:mldnjava@eureka-7003.com:7003/eureka
	  instance:
	    lease-renewal-interval-in-seconds: 2 # 设置心跳的时间间隔（默认是30秒）
	    lease-expiration-duration-in-seconds: 5 # 如果现在超过了5秒的间隔（默认是90秒）
	    instance-id: dept-8001.com  # 在信息列表时显示主机名称
	    prefer-ip-address: true     # 访问的路径变为IP地址
	
	info: 
	  app.name: mldn-microcloud
	  company.name: www.mldn.cn
	  build.artifactId: $project.artifactId$
	  build.version: $project.verson$
	
	spring: 
	  application:
	    name: microcloud-provider-company






**3.修改Host文件进行模拟**

新增：

	127.0.0.1 company-8101.com



**4.验证**

启动microcloud-provider-company， 访问：


    http://company-8101.com:8101/company/get/hello


得到：

    {"title":"hello","note":"www.mldn.cn"}


Hystrix监控地址：

    http://company-8101.com:8101/hystrix.stream


**5.编写Turbine模块**

新建microcloud-consumer-turbine模块






**pom:**

增加turbine的依赖包：

        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-turbine</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-turbine</artifactId>
        </dependency>


此时完整的Pom文件为：


	<?xml version="1.0" encoding="UTF-8"?>
	<project xmlns="http://maven.apache.org/POM/4.0.0"
	         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
	    <parent>
	        <artifactId>microcloud</artifactId>
	        <groupId>com.wzy</groupId>
	        <version>1.0-SNAPSHOT</version>
	    </parent>
	    <modelVersion>4.0.0</modelVersion>
	
	    <artifactId>microcloud-consumer-turbine</artifactId>
	    <name>microcloud-consumer-turbine</name>
	    <url>http://maven.apache.org</url>
	    <properties>
	        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
	    </properties>
	    <dependencies>
	        <dependency>
	            <groupId>org.springframework.cloud</groupId>
	            <artifactId>spring-cloud-starter-turbine</artifactId>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework.cloud</groupId>
	            <artifactId>spring-cloud-starter-hystrix</artifactId>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework.cloud</groupId>
	            <artifactId>spring-cloud-starter-hystrix-dashboard</artifactId>
	        </dependency>
	
	        <dependency>
	            <groupId>org.springframework.cloud</groupId>
	            <artifactId>spring-cloud-starter-feign</artifactId>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework.cloud</groupId>
	            <artifactId>spring-cloud-starter-eureka</artifactId>
	        </dependency>
	
	        <dependency>
	            <groupId>org.springframework.cloud</groupId>
	            <artifactId>spring-cloud-starter-config</artifactId>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework.cloud</groupId>
	            <artifactId>spring-cloud-starter-ribbon</artifactId>
	        </dependency>
	
	        <dependency>
	            <groupId>com.wzy</groupId>
	            <artifactId>mircocloud-api</artifactId>
	            <version>1.0-SNAPSHOT</version>
	            <scope>compile</scope>
	        </dependency>
	        <dependency>
	            <groupId>com.wzy</groupId>
	            <artifactId>microcloud-service</artifactId>
	            <version>1.0-SNAPSHOT</version>
	        </dependency>
	        <dependency>
	            <groupId>junit</groupId>
	            <artifactId>junit</artifactId>
	            <scope>test</scope>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework.boot</groupId>
	            <artifactId>spring-boot-starter-jetty</artifactId>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework.boot</groupId>
	            <artifactId>spring-boot-starter-web</artifactId>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework.boot</groupId>
	            <artifactId>spring-boot-starter-test</artifactId>
	            <scope>test</scope>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework</groupId>
	            <artifactId>springloaded</artifactId>
	        </dependency>
	        <dependency>
	            <groupId>org.springframework.boot</groupId>
	            <artifactId>spring-boot-devtools</artifactId>
	        </dependency>
	    </dependencies>
	</project>




**application.yml：**


	server:
	  port: 9101  # turbine的监听端口为9101
	
	eureka: 
	  client: # 客户端进行Eureka注册的配置
	    service-url:
	      defaultZone: http://edmin:mldnjava@eureka-7001.com:7001/eureka,http://edmin:mldnjava@eureka-7002.com:7002/eureka,http://edmin:mldnjava@eureka-7003.com:7003/eureka
	  instance:
	    lease-renewal-interval-in-seconds: 2 # 设置心跳的时间间隔（默认是30秒）
	    lease-expiration-duration-in-seconds: 5 # 如果现在超过了5秒的间隔（默认是90秒）
	    instance-id: dept-8001.com  # 在信息列表时显示主机名称
	    prefer-ip-address: true     # 访问的路径变为IP地址
	
	turbine: 
	  app-config: MICROCLOUD-PROVIDER-COMPANY,MICROCLOUD-PROVIDER-DEPT  # 定义所有要监控的微服务信息
	  cluster-name-expression: new String("default")  # 设置监控的表达式，通过此表达式表示要获取监控信息名称




app-config:可以接多个微服务。

此时的两个微服务中，有两种情况


-无安全认证: MICROCLOUD-PROVIDER-COMPANY

-有安全认证：MICROCLOUD-PROVIDER-DEPT




---

**TurbineApplication_9101：**

	import org.springframework.boot.SpringApplication;
	import org.springframework.boot.autoconfigure.SpringBootApplication;
	import org.springframework.cloud.netflix.hystrix.dashboard.EnableHystrixDashboard;
	import org.springframework.cloud.netflix.turbine.EnableTurbine;
	@SpringBootApplication
	@EnableHystrixDashboard
	@EnableTurbine
	public class TurbineApplication_9101 {
		public static void main(String[] args) {
			SpringApplication.run(TurbineApplication_9101.class, args);
		}
	}


注意：需要加上@EnableTurbine注解。


![](../Images/33.png)




**6.更新Host文件**

新增

    127.0.0.1 turbine.com




**7.验证**

启动以下服务：

microcloud-consumer-hystrix-dashboard，

microcloud-consumer-turbine

microcloud-provider-hystrix-8001

microcloud-provider-company

microcloud-eureka-7001

microcloud-consumer-feign



调用：

    http://client.com/consumer/dept/list

及


    http://dept-8001.com:8101/company/get/1


激活监控


---
**turbine访问地址：**

http://turbine.com:9101/turbine.stream


**hystrixDashboard监控程序：**

 http://dashboard.com:9001/hystrix




![](../Images/34.png)


监控画面如下：

![](../Images/35.png)


**注意：此时只有一个微服务。加密的微服务相关信息无法读取到。**


---

**8.增加对加密微服务的监控**


microcloud-security：

修改WebSecurityConfig：


新增对WEB的安全策略：

	@Override
	public void configure(WebSecurity web) throws Exception {
		web.ignoring().antMatchers("/hystrix.stream","/turbine.stream") ;
	}


忽略掉/hystrix.stream"以及/turbine.stream结尾的Web请求的安全验证



此时，完整的文件如下：

	import javax.annotation.Resource;
	import org.springframework.context.annotation.Configuration;
	import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
	import org.springframework.security.config.annotation.web.builders.HttpSecurity;
	import org.springframework.security.config.annotation.web.builders.WebSecurity;
	import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
	import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
	import org.springframework.security.config.http.SessionCreationPolicy;
	@Configuration
	@EnableWebSecurity
	public class WebSecurityConfig extends WebSecurityConfigurerAdapter {
		@Resource
		public void configGlobal(AuthenticationManagerBuilder auth)
				throws Exception {
			auth.inMemoryAuthentication().withUser("mldnjava").password("hello")
					.roles("USER").and().withUser("admin").password("hello")
					.roles("USER", "ADMIN");
		}
		@Override
		protected void configure(HttpSecurity http) throws Exception {
			// 表示所有的访问都必须进行认证处理后才可以正常进行
			http.httpBasic().and().authorizeRequests().anyRequest()
					.fullyAuthenticated();
			// 所有的Rest服务一定要设置为无状态，以提升操作性能
			http.sessionManagement()
					.sessionCreationPolicy(SessionCreationPolicy.STATELESS);
		}
	
		@Override
		public void configure(WebSecurity web) throws Exception {
			web.ignoring().antMatchers("/hystrix.stream","/turbine.stream") ;
		}
	
	}



**9.验证**


启动以下服务：

microcloud-consumer-hystrix-dashboard，

microcloud-consumer-turbine

microcloud-provider-hystrix-8001

microcloud-provider-company

microcloud-eureka-7001

microcloud-consumer-feign



调用：

    http://client.com/consumer/dept/list

及


    http://dept-8001.com:8101/company/get/1


激活监控


---
**turbine访问地址：**

http://turbine.com:9101/turbine.stream


**hystrixDashboard监控程序：**

 http://dashboard.com:9001/hystrix



此时，两个微服务都有监控：


![](../Images/36.png)