# 静态化处理

---

## 目的

为了避免频繁渲染，将页面储存下来进行静态化

## 项目文件

### GoodsController：

	package com.wzy.springboot_seckill.controller;
	
	
	import com.wzy.springboot_seckill.entity.Evaluate;
	import com.wzy.springboot_seckill.entity.Goods;
	import com.wzy.springboot_seckill.service.GoodsService;
	import freemarker.template.Configuration;
	import freemarker.template.Template;
	import freemarker.template.TemplateException;
	import org.slf4j.Logger;
	import org.slf4j.LoggerFactory;
	import org.springframework.stereotype.Controller;
	import org.springframework.web.bind.annotation.GetMapping;
	import org.springframework.web.bind.annotation.PathVariable;
	import org.springframework.web.bind.annotation.ResponseBody;
	import org.springframework.web.servlet.ModelAndView;
	
	import javax.annotation.Resource;
	import java.io.File;
	import java.io.FileWriter;
	import java.io.IOException;
	import java.util.HashMap;
	import java.util.List;
	import java.util.Map;
	
	@Controller
	public class GoodsController {
	    Logger logger = LoggerFactory.getLogger(GoodsController.class);
	
	    @Resource
	    private GoodsService goodsService;
	
	    //在SpringBoot IOC容器初始化的时候，自动Configuration就被实例化
	    @Resource
	    private Configuration freemarkerConfig;
	
	    @GetMapping("/goods") //http://localhost:8080/goods?gid=739
	    @ResponseBody
	    public ModelAndView showGoods(Long gid){
	        logger.info("gid:" + gid);
	        ModelAndView mav = new ModelAndView("/goodsview");
	        Goods goods = goodsService.getGoods(gid);
	
	        mav.addObject("goods", goods);
	        mav.addObject("covers", goodsService.findCovers(gid));
	        mav.addObject("details", goodsService.findDetails(gid));
	        mav.addObject("params", goodsService.findParams(gid));
	        return mav;
	    }
	
	    @GetMapping("/static/{gid}")  //http://localhost:8080/static/739
	    @ResponseBody
	    public String doStatic(@PathVariable("gid") Long gid) throws IOException, TemplateException {
	        //获取模板对象
	        Template template = freemarkerConfig.getTemplate("goodsview.ftl");
	        Map param = new HashMap();
	        param.put("goods", goodsService.getGoods(gid));
	        param.put("covers", goodsService.findCovers(gid));
	        param.put("details", goodsService.findDetails(gid));
	        param.put("params", goodsService.findParams(gid));
	        File targetFile = new File("E:/babytun/goods/" + gid + ".html");
	        FileWriter out = new FileWriter(targetFile);
	        template.process(param , out);
	        out.close();
	        return targetFile.getPath();
	    }
	
	    @GetMapping("/static_all")
	    @ResponseBody
	    public String doStatic() throws IOException, TemplateException {
	        //获取模板对象
	        Template template = freemarkerConfig.getTemplate("goods.ftl");
	        List<Goods> allGoods = goodsService.findAllGoods();
	        for (Goods g : allGoods) {
	            Long gid = g.getGoodsId();
	            Map param = new HashMap();
	            param.put("goods", goodsService.getGoods(gid));
	            param.put("covers", goodsService.findCovers(gid));
	            param.put("details", goodsService.findDetails(gid));
	            param.put("params", goodsService.findParams(gid));
	            File targetFile = new File("E:/babytun/goods/" + gid + ".html");
	            FileWriter out = new FileWriter(targetFile);
	            template.process(param , out);
	            out.close();
	        }
	
	        return "ok";
	    }
	    @GetMapping("/evaluate/{gid}")
	    @ResponseBody
	    public List<Evaluate> findEvaluates(@PathVariable("gid") Long goodsId){
	        return goodsService.findEvaluates(goodsId);
	
	    }
	
	}



### EvaluateDAO：

	package com.wzy.springboot_seckill.dao;
	
	import com.wzy.springboot_seckill.entity.Evaluate;
	
	import java.util.List;
	
	public interface EvaluateDAO {
	    public List<Evaluate> findByGoodsId(Long goodsId);
	}


### GoodsDAO：

	package com.wzy.springboot_seckill.dao;
	
	import com.wzy.springboot_seckill.entity.Goods;
	
	import java.util.List;
	
	public interface GoodsDAO {
	    public Goods findById(Long goodsId);
	    public List<Goods> findAll();
	    public List<Goods> findLast5M();
	}


### Evaluate：

	package com.wzy.springboot_seckill.entity;
	
	import java.util.Date;
	
	public class Evaluate {
	    private Long evaluateId;
	    private String content;
	    private Date createTime;
	    private Integer stars;
	    private Long goodsId;
	
	    public Long getEvaluateId() {
	        return evaluateId;
	    }
	
	    public void setEvaluateId(Long evaluateId) {
	        this.evaluateId = evaluateId;
	    }
	
	    public String getContent() {
	        return content;
	    }
	
	    public void setContent(String content) {
	        this.content = content;
	    }
	
	    public Date getCreateTime() {
	        return createTime;
	    }
	
	    public void setCreateTime(Date createTime) {
	        this.createTime = createTime;
	    }
	
	    public Integer getStars() {
	        return stars;
	    }
	
	    public void setStars(Integer stars) {
	        this.stars = stars;
	    }
	
	    public Long getGoodsId() {
	        return goodsId;
	    }
	
	    public void setGoodsId(Long goodsId) {
	        this.goodsId = goodsId;
	    }
	}

### evaluate.xml

	<?xml version="1.0" encoding="UTF-8"?>
	
	<!DOCTYPE mapper
	        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	<mapper namespace="com.wzy.springboot_seckill.dao.EvaluateDAO">
	    <select id="findByGoodsId" parameterType="long" resultType="com.wzy.springboot_seckill.entity.Evaluate">
	        select * from t_evaluate where goods_id = #{value} order by create_time desc
	    </select>
	</mapper>



### goods.xml

	<?xml version="1.0" encoding="UTF-8"?>
	<!DOCTYPE mapper
	        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	<mapper namespace="com.wzy.springboot_seckill.dao.GoodsDAO">
	    <select id="findById" parameterType="long" resultType="com.wzy.springboot_seckill.entity.Goods">
	        select * from t_goods where goods_id = #{value}
	    </select>
	    <select id = "findAll" resultType="com.wzy.springboot_seckill.entity.Goods">
	        select * from t_goods
	    </select>
	    <select id="findLast5M" resultType="com.wzy.springboot_seckill.entity.Goods">
	        select * from t_goods where last_update_time >= now()-interval 5 minute
	    </select>
	</mapper>



## 渲染用文件

将layui放入E:\babytun\goods

![](../Images/12.png)


## 验证

### 生成单个页面

请求：

	http://localhost:8080/static/739

生成文件：

![](../Images/13.png)


### 生成所有页面

	http://localhost:8080/static_all


## 搭建nginx

将静态页面放入nginx中做静态页面

### 启动容器

	docker run --name nginx -p 2222:80 -d nginx
 
### 创建目录

	mkdir -p /root/nginx/{www,logs,conf,conf.d}

### 创建配置文件

	docker cp nginx:/etc/nginx/nginx.conf /root/nginx/conf

	docker cp nginx:/etc/nginx/conf.d/default.conf /root/nginx/conf.d/default.conf
 

### 删除容器

	docker stop nginx

	docker rm nginx


### 构建镜像

	docker run -d -p 2222:80 --name nginx -v /root/nginx/www:/usr/share/nginx/html -v /root/nginx/conf/nginx.conf:/etc/nginx/nginx.conf -v /root/nginx/logs:/var/log/nginx -v /root/nginx/conf.d/default.conf:/etc/nginx/conf.d/default.conf  nginx


### 构建测试页面

将执行

	http://localhost:8080/static_all

生成的html文件上传至

	/root/nginx/www


![](../Images/14.png)





## 测试

	http://47.112.142.231:2222/goods/1333.html


