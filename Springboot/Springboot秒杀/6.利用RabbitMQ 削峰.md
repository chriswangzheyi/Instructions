# 6.利用RabbitMQ 削峰

---

## 项目

![](../Images/17.png)


### SecKillController

	package com.wzy.springboot_seckill.controller;
	
	import com.wzy.springboot_seckill.entity.Order;
	import com.wzy.springboot_seckill.service.PromotionSecKillService;
	import com.wzy.springboot_seckill.service.exception.SecKillException;
	import org.springframework.stereotype.Controller;
	import org.springframework.web.bind.annotation.GetMapping;
	import org.springframework.web.bind.annotation.RequestMapping;
	import org.springframework.web.bind.annotation.ResponseBody;
	import org.springframework.web.servlet.ModelAndView;
	import javax.annotation.Resource;
	import java.util.HashMap;
	import java.util.Map;
	
	@Controller
	public class SecKillController {
	
	    @Resource
	    PromotionSecKillService promotionSecKillService;
	
	    //获取抢购资格
	    //localhost:8080\seckill?psid=1&userid=user001
	    @RequestMapping("/seckill")
	    @ResponseBody
	    public Map processSecKill(Long psid , String userid){
	
	        Map result = new HashMap();
	
	        try {
	            promotionSecKillService.processSecKill(psid , userid , 1);
	            String orderNo = promotionSecKillService.sendOrderToQueue(userid);
	            Map data = new HashMap();
	            data.put("orderNo", orderNo);
	            result.put("code", "0"); //code0表示操作成功
	            result.put("message", "success");
	            result.put("data", data);
	        } catch (SecKillException e) {
	            result.put("code", "500");
	            result.put("message", e.getMessage());
	        }
	        return result;
	    }
	
	    //查询订单详情
	    //http://localhost:8080/checkorder?orderNo=df79877c-85f1-4305-8f95-72572381d0de
	    @GetMapping("/checkorder")
	    public ModelAndView checkOrder(String orderNo){
	        Order order =  promotionSecKillService.checkOrder(orderNo);
	        ModelAndView mav = new ModelAndView();
	        if(order != null){
	            mav.addObject("order", order);
	            mav.setViewName("/order");
	        }else{
	            mav.addObject("orderNo", orderNo);
	            mav.setViewName("/waiting");
	        }
	        return mav;
	    }
	}


### OrderDAO

	package com.wzy.springboot_seckill.dao;
	
	import com.wzy.springboot_seckill.entity.Order;
	
	public interface OrderDAO {
	    public void insert(Order order);
	
	    public Order findByOrderNo(String orderNo);
	}

### PromotionSecKillDAO

	package com.wzy.springboot_seckill.dao;
	
	import com.wzy.springboot_seckill.entity.PromotionSecKill;
	
	import java.util.List;
	
	public interface PromotionSecKillDAO {
	    List<PromotionSecKill> findUnstartSecKill();
	    void update(PromotionSecKill ps);
	    PromotionSecKill findById(Long psId);
	    List<PromotionSecKill> findExpireSecKill();
	}

### Order

	package com.wzy.springboot_seckill.entity;
	
	import java.util.Date;
	
	public class Order {
	    private Long orderId;
	    private String orderNo;
	    private Integer orderStatus;
	    private String userid;
	    private String recvName;
	    private String recvAddress;
	    private String recvMobile;
	    private Float postage;
	    private Float amout;
	    private Date createTime;
	
	    public Long getOrderId() {
	        return orderId;
	    }
	
	    public void setOrderId(Long orderId) {
	        this.orderId = orderId;
	    }
	
	    public String getOrderNo() {
	        return orderNo;
	    }
	
	    public void setOrderNo(String orderNo) {
	        this.orderNo = orderNo;
	    }
	
	    public Integer getOrderStatus() {
	        return orderStatus;
	    }
	
	    public void setOrderStatus(Integer orderStatus) {
	        this.orderStatus = orderStatus;
	    }
	
	    public String getUserid() {
	        return userid;
	    }
	
	    public void setUserid(String userid) {
	        this.userid = userid;
	    }
	
	    public String getRecvName() {
	        return recvName;
	    }
	
	    public void setRecvName(String recvName) {
	        this.recvName = recvName;
	    }
	
	    public String getRecvAddress() {
	        return recvAddress;
	    }
	
	    public void setRecvAddress(String recvAddress) {
	        this.recvAddress = recvAddress;
	    }
	
	    public String getRecvMobile() {
	        return recvMobile;
	    }
	
	    public void setRecvMobile(String recvMobile) {
	        this.recvMobile = recvMobile;
	    }
	
	    public Float getPostage() {
	        return postage;
	    }
	
	    public void setPostage(Float postage) {
	        this.postage = postage;
	    }
	
	    public Float getAmout() {
	        return amout;
	    }
	
	    public void setAmout(Float amout) {
	        this.amout = amout;
	    }
	
	    public Date getCreateTime() {
	        return createTime;
	    }
	
	    public void setCreateTime(Date createTime) {
	        this.createTime = createTime;
	    }
	}

### PromotionSecKill

	package com.wzy.springboot_seckill.entity;
	
	import java.util.Date;
	
	public class PromotionSecKill {
	    private Long psId;
	    private Long goodsId;
	    private Integer psCount;
	    private Date startTime;
	    private Date endTime;
	    private Integer status;
	    private Float currentPrice;
	
	    public Long getPsId() {
	        return psId;
	    }
	
	    public void setPsId(Long psId) {
	        this.psId = psId;
	    }
	
	    public Long getGoodsId() {
	        return goodsId;
	    }
	
	    public void setGoodsId(Long goodsId) {
	        this.goodsId = goodsId;
	    }
	
	    public Integer getPsCount() {
	        return psCount;
	    }
	
	    public void setPsCount(Integer psCount) {
	        this.psCount = psCount;
	    }
	
	    public Date getStartTime() {
	        return startTime;
	    }
	
	    public void setStartTime(Date startTime) {
	        this.startTime = startTime;
	    }
	
	    public Date getEndTime() {
	        return endTime;
	    }
	
	    public void setEndTime(Date endTime) {
	        this.endTime = endTime;
	    }
	
	    public Integer getStatus() {
	        return status;
	    }
	
	    public void setStatus(Integer status) {
	        this.status = status;
	    }
	
	    public Float getCurrentPrice() {
	        return currentPrice;
	    }
	
	    public void setCurrentPrice(Float currentPrice) {
	        this.currentPrice = currentPrice;
	    }
	}


###SecKillTask
	
	package com.wzy.springboot_seckill.scheduler;
	
	import com.wzy.springboot_seckill.dao.PromotionSecKillDAO;
	import com.wzy.springboot_seckill.entity.PromotionSecKill;
	import org.springframework.data.redis.core.RedisTemplate;
	import org.springframework.scheduling.annotation.Scheduled;
	import org.springframework.stereotype.Component;
	import javax.annotation.Resource;
	import java.util.List;
	
	@Component
	public class SecKillTask {
	    @Resource
	    private PromotionSecKillDAO promotionSecKillDAO;
	    //RedisTempldate是Spring封装的Redis操作类，提供了一系列操作redis的模板方法
	    @Resource
	    private RedisTemplate redisTemplate;
	
	    //每隔5秒执行一次
	    @Scheduled(cron = "0/5 * * * * ?")
	    public void startSecKill(){
	        //根据起始时间及状态码（0为未启动）查询到时间却未启动的任务
	        List<PromotionSecKill> list  = promotionSecKillDAO.findUnstartSecKill();
	
	        for(PromotionSecKill ps : list){
	            System.out.println(ps.getPsId() + "秒杀活动已启动");
	            //删掉以前重复的活动任务缓存
	            redisTemplate.delete("seckill:count:" + ps.getPsId());
	            //有几个库存商品，则初始化几个list对象
	            for(int i = 0 ; i < ps.getPsCount() ; i++){
	                redisTemplate.opsForList().rightPush("seckill:count:" + ps.getPsId(), ps.getGoodsId().toString());
	            }
	            //将任务状态设置为1（启动）
	            ps.setStatus(1);
	            promotionSecKillDAO.update(ps);
	        }
	    }
	
	    @Scheduled(cron = "0/5 * * * * ?")
	    public void endSecKill(){
	        List<PromotionSecKill> psList = promotionSecKillDAO.findExpireSecKill();
	        for (PromotionSecKill ps : psList) {
	            System.out.println(ps.getPsId() + "秒杀活动已结束");
	            ps.setStatus(2);
	            promotionSecKillDAO.update(ps);
	            redisTemplate.delete("seckill:count:" + ps.getPsId());
	        }
	    }
	}


### SecKillException

	package com.wzy.springboot_seckill.service.exception;
	
	
	public class SecKillException extends Exception{
	    public SecKillException(String msg){
	        super(msg);
	    }
	}


### OrderConsumer

	package com.wzy.springboot_seckill.service;
	
	import com.rabbitmq.client.Channel;
	import com.wzy.springboot_seckill.dao.OrderDAO;
	import com.wzy.springboot_seckill.entity.Order;
	import org.springframework.amqp.rabbit.annotation.*;
	import org.springframework.amqp.support.AmqpHeaders;
	import org.springframework.messaging.handler.annotation.Headers;
	import org.springframework.messaging.handler.annotation.Payload;
	import org.springframework.stereotype.Component;
	import javax.annotation.Resource;
	import java.io.IOException;
	import java.util.Date;
	import java.util.Map;
	
	@Component
	public class OrderConsumer {
	    @Resource
	    private OrderDAO orderDAO;
	
	    @RabbitListener(
	            bindings = @QueueBinding(
	                    value = @Queue(value = "queue-order") ,
	                    exchange = @Exchange(value = "exchange-order" , type = "fanout")
	            )
	    )
	
	    @RabbitHandler
	    public void handleMessage(@Payload Map data , Channel channel ,
	                              @Headers Map<String,Object> headers){
	        System.out.println("=======获取到订单数据:" + data + "===========);");
	
	        try {
	            //模拟对接支付宝、对接物流系统、日志登记。。。。
	            try {
	                Thread.sleep(10000);
	            } catch (InterruptedException e) {
	                e.printStackTrace();
	            }
	
	            Order order = new Order();
	            order.setOrderNo(data.get("orderNo").toString());
	            order.setOrderStatus(0);
	            order.setUserid(data.get("userid").toString());
	            order.setRecvName("xxx");
	            order.setRecvMobile("1393310xxxx");
	            order.setRecvAddress("xxxxxxxxxx");
	            order.setAmout(19.8f);
	            order.setPostage(0f);
	            order.setCreateTime(new Date());
	            orderDAO.insert(order);
	            Long tag = (Long)headers.get(AmqpHeaders.DELIVERY_TAG);
	            channel.basicAck(tag , false);//消息确认
	            System.out.println(data.get("orderNo") + "订单已创建");
	        } catch (IOException e) {
	            e.printStackTrace();
	        }
	    }
	}

### PromotionSecKillService

	package com.wzy.springboot_seckill.service;
	
	
	import com.wzy.springboot_seckill.dao.OrderDAO;
	import com.wzy.springboot_seckill.dao.PromotionSecKillDAO;
	import com.wzy.springboot_seckill.entity.Order;
	import com.wzy.springboot_seckill.entity.PromotionSecKill;
	import com.wzy.springboot_seckill.service.exception.SecKillException;
	import org.springframework.amqp.rabbit.core.RabbitTemplate;
	import org.springframework.data.redis.core.RedisTemplate;
	import org.springframework.stereotype.Service;
	
	import javax.annotation.Resource;
	import java.util.HashMap;
	import java.util.Map;
	import java.util.UUID;
	
	@Service
	public class PromotionSecKillService {
	    @Resource
	    private PromotionSecKillDAO promotionSecKillDAO;
	    @Resource
	    private RedisTemplate redisTemplate;
	    @Resource //RabbitMQ客户端
	    private RabbitTemplate rabbitTemplate;
	
	    @Resource
	    private OrderDAO orderDAO;
	
	    // psid商品id, userid用户id， 商品库存num
	    public void processSecKill(Long psId, String userid, Integer num) throws SecKillException {
	        PromotionSecKill ps = promotionSecKillDAO.findById(psId);
	        if (ps == null) {
	            //秒杀活动不存在
	            throw new SecKillException("秒杀活动不存在");
	        }
	        if (ps.getStatus() == 0) {
	            throw new SecKillException("秒杀活动还未开始");
	        } else if (ps.getStatus() == 2) {
	            throw new SecKillException("秒杀活动已经结束");
	        }
	
	        //从redis中根据key值取数，判断是否有秒杀活动，并将秒杀的商品减一
	        Integer goodsId = Integer.valueOf(redisTemplate.opsForList()
	                .leftPop("seckill:count:" + ps.getPsId()).toString() );
	
	        //如果有秒杀活动
	        if (goodsId != null) {
	
	            //判断是否已经抢购过
	            boolean isExisted = redisTemplate.opsForSet().isMember("seckill:users:" + ps.getPsId(), userid);
	
	            if (!isExisted) {
	                System.out.println("恭喜您，抢到商品啦。快去下单吧");
	                redisTemplate.opsForSet().add("seckill:users:" + ps.getPsId(), userid);
	            }else{
	                //将刚刚因为leftpop减一的秒杀商品数量加一
	                redisTemplate.opsForList().rightPush("seckill:count:" + ps.getPsId(), ps.getGoodsId().toString());
	                throw new SecKillException("抱歉，您已经参加过此活动，请勿重复抢购！");
	            }
	        } else {
	            throw new SecKillException("抱歉，该商品已被抢光，下次再来吧！！");
	        }
	    }
	
	    //发送订单到RabbitMQ
	    public String sendOrderToQueue(String userid) {
	        System.out.println("准备向队列发送信息");
	        //订单基本信息
	        Map data = new HashMap();
	        data.put("userid", userid);
	        String orderNo = UUID.randomUUID().toString();
	        data.put("orderNo", orderNo);
	        //附加额外的订单信息
	        rabbitTemplate.convertAndSend("exchange-order" , null , data);
	        return orderNo;
	    }
	
	    public Order checkOrder(String orderNo){
	        Order order = orderDAO.findByOrderNo(orderNo);
	        return order;
	    }
	}


### RedisConfig

	package com.wzy.springboot_seckill.utils;
	
	import org.springframework.cache.interceptor.KeyGenerator;
	import org.springframework.context.annotation.Bean;
	import org.springframework.context.annotation.Configuration;
	import org.springframework.data.redis.connection.RedisConnectionFactory;
	import org.springframework.data.redis.core.RedisTemplate;
	import org.springframework.data.redis.serializer.RedisSerializer;
	import org.springframework.data.redis.serializer.StringRedisSerializer;
	
	import java.lang.reflect.Method;
	
	
	@Configuration
	public class RedisConfig {
	
	    //避免生成乱码
	    @Bean
	    public KeyGenerator keyGenerator() {
	        return new KeyGenerator() {
	            @Override
	            public Object generate(Object target, Method method, Object... params) {
	                StringBuilder sb = new StringBuilder();
	                sb.append(target.getClass().getName());
	                sb.append(method.getName());
	                for (Object obj : params) {
	                    sb.append(obj.toString());
	                }
	                return sb.toString();
	            }
	        };
	    }
	
	
	
	    @Bean
	    public RedisTemplate<String, String> redisTemplate(RedisConnectionFactory redisConnectionFactory) {
	        RedisTemplate<String, String> redisTemplate = new RedisTemplate<>();
	        RedisSerializer stringSerializer = new StringRedisSerializer();
	
	        //设置序列化方式
	        redisTemplate.setKeySerializer(stringSerializer);
	        redisTemplate.setValueSerializer(stringSerializer);
	        redisTemplate.setHashKeySerializer(stringSerializer);
	        redisTemplate.setHashValueSerializer(stringSerializer);
	
	        redisTemplate.setConnectionFactory(redisConnectionFactory);
	        return redisTemplate;
	    }
	}


### SpringbootSeckillApplication

	package com.wzy.springboot_seckill;
	
	import org.springframework.boot.SpringApplication;
	import org.springframework.boot.autoconfigure.SpringBootApplication;
	
	import org.mybatis.spring.annotation.MapperScan;
	import org.springframework.context.annotation.Bean;
	import org.springframework.data.redis.connection.RedisConnectionFactory;
	import org.springframework.data.redis.core.RedisTemplate;
	import org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;
	import org.springframework.data.redis.serializer.StringRedisSerializer;
	import org.springframework.scheduling.annotation.EnableScheduling;
	
	@SpringBootApplication
	@MapperScan("com.wzy.springboot_seckill")
	@EnableScheduling //启用任务调度功能
	
	public class SpringbootSeckillApplication {
	    //修改默认的redisTemplate持久化方式
	    public RedisTemplate<Object, Object> redisTemplate(RedisConnectionFactory redisConnectionFactory) {
	        RedisTemplate<Object, Object> redisTemplate = new RedisTemplate<>();
	        redisTemplate.setConnectionFactory(redisConnectionFactory);
	        Jackson2JsonRedisSerializer jackson2JsonRedisSerializer = new Jackson2JsonRedisSerializer(Object.class);
	        //设置value的序列化方式为JSOn
	        redisTemplate.setValueSerializer(jackson2JsonRedisSerializer);
	        //设置key的序列化方式为String
	        redisTemplate.setKeySerializer(new StringRedisSerializer());
	        return redisTemplate;
	    }
	    public static void main(String[] args) {
	        SpringApplication.run(SpringbootSeckillApplication.class, args);
	    }
	}


### order.xml
	
	<?xml version="1.0" encoding="UTF-8"?>
	<!DOCTYPE mapper
	        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	<mapper namespace="com.wzy.springboot_seckill.dao.OrderDAO">
	    <insert id="insert" parameterType="com.wzy.springboot_seckill.entity.Order">
	        insert into t_order(order_no , order_status , userid , recv_name , recv_address , recv_mobile,postage , amout , create_time)
	        value (#{orderNo} , #{orderStatus} , #{userid} , #{recvName} , #{recvAddress} , #{recvMobile} , #{postage} , #{amout} , #{createTime})
	        <selectKey resultType="Long" keyProperty="orderId">
	            SELECT LAST_INSERT_ID() AS ID
	        </selectKey>
	    </insert>
	    <select id="findByOrderNo" parameterType="java.lang.String" resultType="com.wzy.springboot_seckill.entity.Order">
	        select * from t_order where order_no  =#{value}
	    </select>
	</mapper>


### promotion_seckill.xml

	<?xml version="1.0" encoding="UTF-8"?>
	<!DOCTYPE mapper
	        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	<mapper namespace="com.wzy.springboot_seckill.dao.PromotionSecKillDAO">
    <select id="findById" parameterType="long" resultType="com.wzy.springboot_seckill.entity.PromotionSecKill">
      select * from t_promotion_seckill where ps_id = #{value}
    </select>

    <select id="findUnstartSecKill" resultType="com.wzy.springboot_seckill.entity.PromotionSecKill">
        select * from t_promotion_seckill where now() BETWEEN start_time AND end_time and status = 0 ;
    </select>

    <select id="findExpireSecKill" resultType="com.wzy.springboot_seckill.entity.PromotionSecKill">
        select * from t_promotion_seckill where now() > end_time and status = 1
    </select>

    <update id="update" parameterType="com.wzy.springboot_seckill.entity.PromotionSecKill">
        UPDATE t_promotion_seckill SET goods_id = #{goodsId}, ps_count = #{psCount},
            start_time = #{startTime}, end_time = #{endTime},
            status=#{status} , current_price = #{currentPrice}  WHERE ps_id = #{psId}
    </update>
	</mapper>


### application.yml

	server:
	  port: 8080
	spring:
	  datasource:
	    driver-class-name: com.mysql.cj.jdbc.Driver
	    url: jdbc:mysql://47.112.142.231:3306/babytun?useUnicode=true&characterEncoding=utf-8&useSSL=false
	    username: root
	    password: root
	  redis:
	    host: 47.112.142.231
	    port: 6379
	    database: 2
	  rabbitmq:
	    host: 47.112.142.231
	    port: 5672
	    username: guest
	    password: guest
	    virtual-host: /
	    listener:
	      simple:
	        #定义消费者做多同时处理10个消息
	        prefetch: 10
	        #消息手动确认
	        acknowledge-mode: manual
	  ## Freemarker 配置
	  freemarker:
	    cache: false
	    charset: UTF-8
	    check-template-location: true
	    content-type: text/html
	    expose-request-attributes: true
	    expose-session-attributes: true
	    request-context-attribute: request
	    suffix: .ftl
	    template-loader-path: classpath:/templates/
	mybatis:
	  mapper-locations: classpath:/mapper/*.xml
	  configuration:
	    map-underscore-to-camel-case: true


## 原理

![](../Images/18.png)


客户端（seckill）发起秒杀请求，微服务收到后，推送到RabbitMQ。RabbitMQ为异步处理。RabbitMQ然后异步从Order Coumsumer处拉取信息进行消费。


## 测试

使用JMeter

![](../Images/19.png)

![](../Images/20.png)

![](../Images/21.png)


修改数据库

![](../Images/22.png)

启动项目后，Redis自动初始化了商品的100个副本。100的数量是根据t_promotion_seckill中的ps_count设定的。

![](../Images/23.png)


观察RabbitMQ

![](../Images/24.png)

最多处理的任务是10个（在Springboot中设置的）


此时可以看到Redis中储存的抢购到的用户名单：
![](../Images/25.png)


**浏览器端验证：**


	#订单存在时候
	http://localhost:8080/checkorder?orderNo=7db350a2-30f0-43e9-80a4-2cbc27dc65d1

![](../Images/26.png)

	#订单不存在时候
	http://localhost:8080/checkorder?orderNo=7db350a2-30f0-43e9-80a4-2cbc27dc65d11

![](../Images/27.png)