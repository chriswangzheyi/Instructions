# 分区表

## 定义

数据分区是一种纵向切分。借助数据分区，在后续的查询过程中能够跳过不必要的数据目录，从而提升查询的性能。合理地利用分区特性，还可以变相实现数据的更新操作，因为数据分区支持删除、替换和重置操作。 牧区只有合并树（MergeTree）家族系列的表引擎才支持数据分区。

## 例子

	create table log(
	id String ,
	ctime DateTime )
	engine=MergeTree() 
	partition by toYYYYMM(ctime) 
	order by id ;
	
例子中，分区是按照ctime这个字段做区分的。


插入数据

	insert into log values (1,'2020-12-27 11:00:21'), (2,'2020-12-26 11:00:21'), (3,'2020-12-25 11:00:21'), (4,'2020-11-27 11:00:21'), (5,'2020-11-21 11:00:21'), (6,'2020-10-27 11:00:21');
	
查看结果	

	SELECT * FROM log
	
	┌─id─┬───────────────ctime─┐
	│ 6  │ 2020-10-27 11:00:21 │
	└────┴─────────────────────┘
	┌─id─┬───────────────ctime─┐
	│ 4  │ 2020-11-27 11:00:21 │
	│ 5  │ 2020-11-21 11:00:21 │
	└────┴─────────────────────┘
	┌─id─┬───────────────ctime─┐
	│ 1  │ 2020-12-27 11:00:21 │
	│ 2  │ 2020-12-26 11:00:21 │
	│ 3  │ 2020-12-25 11:00:21 │
	└────┴─────────────────────┘
	
可以看到记录被按照月份，分为了不同的区


## 查看分区

	SELECT name, partition, table
	FROM system.parts WHERE table = 'log';
	
结果

	┌─name─────────┬─partition─┬─table─┐
	│ 202010_3_3_0 │ 202010    │ log   │
	│ 202011_2_2_0 │ 202011    │ log   │
	│ 202012_1_1_0 │ 202012    │ log   │
	└──────────────┴───────────┴───────┘
	
## 删除分区

	ALTER TABLE tb_name DROP PARTITION partition_expr ;
	alter table log drop partition '202011' ; -- 会将指定分区分区删除, 并且分区中分数据也会被删除
	
## 复制分区

	ALTER TABLE B REPLACE PARTITION partition_expr FROM A
	
例子：

	create table log1( id String , ctime DateTime )engine=MergeTree() partition by toYYYYMM(ctime) order by id ;
	create table log2( id String , ctime DateTime )engine=MergeTree() partition by toYYYYMM(ctime) order by id ;
	insert into log1 values(1,'2020-12-21 00:00:00'),(2,'2020-12-22 00:00:00'),(3,'2020-12-23 00:00:00'),(4,'2020-11-21 00:00:00')
	alter table log2 replace partition 202011 from log1 ;
	
## 重置分区数据

	ALTER TABLE tb_name CLEAR COLUMN column_name IN PARTITION partition_expr 
	Alter table log2 claer column id in partition 202011 ; 注意的是不能重置主键和分区字段
	
## 卸载和装载分区

	卸载 202012 分区中的数据
	alter table log2 detach partition 202012;
	
	alter table log2 attach partition 202012 ;装载以后数据就会被加载到表下