# 16. 测流输出

## 定义

大部分的DataStream API的算子的输出是单一输出，也就是某种数据类型的流。除了split算子，可以将一条流分成多条流，这些流的数据类型也都相同。process function的side outputs功能可以产生多条流，并且这些流的数据类型可以不一样。一个side output可以定义为OutputTag[X]对象，X是输出流的数据类型。process function可以通过Context对象发射一个事件到一个或者多个side outputs


## ProcessFunction

Flink提供了8个Process Function：

* ProcessFunction：dataStream
* KeyedProcessFunction：用于KeyedStream，keyBy之后的流处理
* CoProcessFunction：用于connect连接的流
* ProcessJoinFunction：用于join流操作
* BroadcastProcessFunction：用于广播
* KeyedBroadcastProcessFunction：keyBy之后的广播
* ProcessWindowFunction：窗口增量聚合
* ProcessAllWindowFunction：全窗口聚合



## Demo

### 代码

	package wzy
	
	
	import org.apache.flink.streaming.api.functions.ProcessFunction
	import org.apache.flink.streaming.api.scala._
	import org.apache.flink.util.Collector
	
	
	case class SensorReading(id: String,timestamp: Long, temperature: Double)
	
	object onTimerDemo {
	
	  def main(args: Array[String]): Unit = {
	    val env: StreamExecutionEnvironment = StreamExecutionEnvironment.getExecutionEnvironment
	    env.setParallelism(1)
	
	
	    val socketSource: DataStream[String] = env.socketTextStream("47.112.142.231", 9999)
	
	    val dataStream = socketSource.map(data => {
	      val arr: Array[String] = data.split(",")
	      SensorReading(arr(0), arr(1).toLong, arr(2).toDouble)
	    })
	
	    val hightStream= dataStream.process(new SplitTemp(35.5))
	
	    hightStream.print("high")
	    hightStream.getSideOutput(new OutputTag[(String,Long,Double)]("low")).print("low")
	    env.execute("SideOutPutTest Test")
	
	  }
	}
	
	//分流测试
	class SplitTemp(threshold:Double) extends ProcessFunction[SensorReading,SensorReading]{
	  override def processElement(i: SensorReading, context: ProcessFunction[SensorReading, SensorReading]#Context, collector: Collector[SensorReading]): Unit = {
	
	    if(i.temperature > threshold){
	      //如果温度大于35.5，那么输出到主流
	      collector.collect(i)
	    }else {
	      //如果温度小于35.5，那么输出到测流
	      context.output(new OutputTag[(String, Long, Double)]("low"), (i.id, i.timestamp, i.temperature))
	    }
	  }
	}
	


### 验证


数据源：

	sensor_1,1547718192,50.0
	sensor_1,1547718192,10.0

flink侧

	high> SensorReading(sensor_1,1547718192,50.0)
	low> (sensor_1,1547718192,10.0)