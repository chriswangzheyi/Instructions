# 11.Watermark

## 概念


## Demo

### 代码

	package wzy
	
	import java.time.Duration
	
	import org.apache.flink.api.common.eventtime.{SerializableTimestampAssigner, WatermarkStrategy}
	import org.apache.flink.api.scala.createTypeInformation
	import org.apache.flink.streaming.api.scala.StreamExecutionEnvironment
	import org.apache.flink.streaming.api.windowing.assigners.{TumblingEventTimeWindows}
	import org.apache.flink.streaming.api.windowing.time.Time
	
	case class Info(text: String, timeRecord: Long)
	
	object WatermarkDemo {
	
	  def main(args: Array[String]): Unit = {
	
	    val env = StreamExecutionEnvironment.getExecutionEnvironment
	    env.setParallelism(1)
	    val text = env.socketTextStream("47.112.142.231", 9999)
	
	    val withTimestampsAndWatermarks = text
	      .assignTimestampsAndWatermarks(WatermarkStrategy.forBoundedOutOfOrderness(Duration.ofSeconds(20)) //延迟20秒
	      .withTimestampAssigner(new SerializableTimestampAssigner[String] {
	        override def extractTimestamp(t: String, l: Long): Long = {
	          t.split(",")(1).toLong * 1000l
	        }
	      })
	      )
	
	
	    val counts =withTimestampsAndWatermarks
	      .map(_.split(",")(0))
	      .map { (_, 1) }
	      .keyBy( _._1)
	      .window(TumblingEventTimeWindows.of(Time.seconds(5)))
	      .sum(1)
	
	
	    counts.print()
	
	    env.execute("WatermarkDemo")
	
	  }
	
	}
