# 1. 通过Data-processor 准备测试数据

## 下载项目

	https://github.com/CloudWise-OpenSource/Data-Processer

## 打包项目

进入到项目目录（有pom的那一层）

	mvn clean package

在target目录下可以看到生成了simulatedata-generator-0.0.1.jar文件。


## 添加到本地仓库

在target目录下执行

	mvn install:install-file -Dfile=simulatedata-generator-0.0.1.jar -DgroupId=com.cloudwise.toushibao -DartifactId=simulatedata-generator -Dversion=0.0.1 -Dpackaging=jar


## 引入依赖方法

项目的pom文件中添加jar包依赖

	<dependency>
		<groupId>com.cloudwise.toushibao</groupId>
		<artifactId>simulatedata-generator</artifactId>
		<version>0.0.1</version>
	</dependency>



## 代码


	package com.wzy.stream.userPurchaseBehaviorTracker.simulator;
	
	import com.cloudwise.sdg.dic.DicInitializer;
	import com.cloudwise.sdg.template.TemplateAnalyzer;
	import org.apache.kafka.clients.producer.KafkaProducer;
	import org.apache.kafka.clients.producer.ProducerRecord;
	
	import java.util.Properties;
	import java.util.Random;
	
	/**
	 * 模拟产生数据
	 *
	 * @author dajiangtai
	 * @create 2019-06-23-16:37
	 */
	public class UserEventsSimulator {
	    public static void main(String[] args) throws Exception{
	        //加载词典(只需执行一次即可)
	        DicInitializer.init();
	
	        //编辑模版
	        String userEventTpl = "{\"userId\":\"$Dic{userId}\",\"channel\":\"$Dic{channel}\",\"eventType\":\"$Dic{eventType}\",\"eventTime\":\"$Dic{eventTime}\",\"data\":{\"productId\":$Dic{productId}}}";
	
	        String purchaseUserEventTpl = "{\"userId\":\"$Dic{userId}\",\"channel\":\"$Dic{channel}\",\"eventType\":\"PURCHASE\",\"eventTime\":\"$Dic{eventTime}\",\"data\":{\"productId\":$Dic{productId},\"price\":$Dic{price},\"amount\":$Dic{amount}}}";
	
	        //创建模版分析器
	        TemplateAnalyzer userEventTplAnalyzer = new TemplateAnalyzer("userEvent", userEventTpl);
	
	        TemplateAnalyzer purchaseUserEventTplAnalyzer = new TemplateAnalyzer("purchaseUserEventTpl", purchaseUserEventTpl);
	
	
	        Properties props = new Properties();
	        props.put("bootstrap.servers", "47.112.142.231:9092");
	        props.put("key.serializer", "org.apache.kafka.common.serialization.StringSerializer");
	        props.put("value.serializer", "org.apache.kafka.common.serialization.StringSerializer");
	        KafkaProducer producer = new KafkaProducer<String, String>(props);
	
	        ProducerRecord record;
	        for(int i=1;i<=100000;i++){
	            //分析模版生成模拟数据
	            record = new ProducerRecord<String, String>(
	                    "purchasePathAnalysisInPut",
	                    null,
	                    new Random().nextInt()+"",
	                    userEventTplAnalyzer.analyse()); //userEventTplAnalyzer
	            producer.send(record);
	            long sleep = (long) (Math.random()*2000);
	            Thread.sleep(sleep);
	            System.out.println("------------"+sleep+"----"+sleep%2);
	
	            if(sleep%2==0&&sleep>800){
	                System.out.println("------------"+sleep+"----"+sleep%2);
	
	                record = new ProducerRecord<String, String>(
	                        "purchasePathAnalysisInPut",
	                        null,
	                        new Random().nextInt()+"",
	                        purchaseUserEventTplAnalyzer.analyse());    //purchaseUserEventTplAnalyzer
	                producer.send(record);
	            }
	        }
	    }
	}


## pom

	<?xml version="1.0" encoding="UTF-8"?>
	<project xmlns="http://maven.apache.org/POM/4.0.0"
	         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
	    <modelVersion>4.0.0</modelVersion>
	
	    <groupId>org.example</groupId>
	    <artifactId>e-comerce-demo</artifactId>
	    <version>1.0-SNAPSHOT</version>
	
	    <properties>
	        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
	        <flink.version>1.8.0</flink.version>
	        <java.version>1.8</java.version>
	        <scala.binary.version>2.11</scala.binary.version>
	        <maven.compiler.source>${java.version}</maven.compiler.source>
	        <maven.compiler.target>${java.version}</maven.compiler.target>
	    </properties>
	
	    <repositories>
	        <repository>
	            <id>apache.snapshots</id>
	            <name>Apache Development Snapshot Repository</name>
	            <url>https://repository.apache.org/content/repositories/snapshots/</url>
	            <releases>
	                <enabled>false</enabled>
	            </releases>
	            <snapshots>
	                <enabled>true</enabled>
	            </snapshots>
	        </repository>
	    </repositories>
	
	    <dependencies>
	        <!-- Apache Flink dependencies -->
	        <!-- These dependencies are provided, because they should not be packaged into the JAR file. -->
	        <dependency>
	            <groupId>org.apache.flink</groupId>
	            <artifactId>flink-java</artifactId>
	            <version>${flink.version}</version>
	            <scope>provided</scope>
	        </dependency>
	        <dependency>
	            <groupId>org.apache.flink</groupId>
	            <artifactId>flink-streaming-java_${scala.binary.version}</artifactId>
	            <version>${flink.version}</version>
	            <scope>provided</scope>
	        </dependency>
	
	        <dependency>
	            <groupId>org.apache.flink</groupId>
	            <artifactId>flink-scala_2.11</artifactId>
	            <version>${flink.version}</version>
	            <scope>provided</scope>
	        </dependency>
	        <dependency>
	            <groupId>org.apache.flink</groupId>
	            <artifactId>flink-streaming-scala_2.11</artifactId>
	            <version>${flink.version}</version>
	            <scope>provided</scope>
	        </dependency>
	        <!-- https://mvnrepository.com/artifact/org.apache.flink/flink-connector-kafka-0.10 -->
	        <dependency>
	            <groupId>org.apache.flink</groupId>
	            <artifactId>flink-connector-kafka-0.10_2.11</artifactId>
	            <version>${flink.version}</version>
	        </dependency>
	        <!-- https://mvnrepository.com/artifact/org.apache.bahir/flink-connector-redis -->
	        <dependency>
	            <groupId>org.apache.bahir</groupId>
	            <artifactId>flink-connector-redis_2.11</artifactId>
	            <version>1.0</version>
	        </dependency>
	        <dependency>
	            <groupId>com.alibaba</groupId>
	            <artifactId>fastjson</artifactId>
	            <version>1.2.54</version>
	        </dependency>
	        <dependency>
	            <groupId>org.projectlombok</groupId>
	            <artifactId>lombok</artifactId>
	            <version>1.18.0</version>
	            <!--<scope>provided</scope>-->
	        </dependency>
	        <!-- Add connector dependencies here. They must be in the default scope (compile). -->
	
	        <!-- Example:
	
	        <dependency>
	            <groupId>org.apache.flink</groupId>
	            <artifactId>flink-connector-kafka-0.10_${scala.binary.version}</artifactId>
	            <version>${flink.version}</version>
	        </dependency>
	        -->
	        <dependency>
	            <groupId>com.cloudwise.toushibao</groupId>
	            <artifactId>simulatedata-generator</artifactId>
	            <version>0.0.1</version>
	        </dependency>
	
	
	        <!-- Add logging framework, to produce console output when running in the IDE. -->
	        <!-- These dependencies are excluded from the application JAR by default. -->
	        <dependency>
	            <groupId>org.slf4j</groupId>
	            <artifactId>slf4j-log4j12</artifactId>
	            <version>1.7.7</version>
	            <scope>runtime</scope>
	        </dependency>
	        <dependency>
	            <groupId>log4j</groupId>
	            <artifactId>log4j</artifactId>
	            <version>1.2.17</version>
	            <scope>runtime</scope>
	        </dependency>
	    </dependencies>
	
	    <build>
	        <plugins>
	
	            <!-- Java Compiler -->
	            <plugin>
	                <groupId>org.apache.maven.plugins</groupId>
	                <artifactId>maven-compiler-plugin</artifactId>
	                <version>3.1</version>
	                <configuration>
	                    <source>${java.version}</source>
	                    <target>${java.version}</target>
	                </configuration>
	            </plugin>
	
	            <!-- scala编译插件 -->
	            <plugin>
	                <groupId>net.alchim31.maven</groupId>
	                <artifactId>scala-maven-plugin</artifactId>
	                <version>3.1.6</version>
	                <configuration>
	                    <scalaCompatVersion>2.11</scalaCompatVersion>
	                    <scalaVersion>2.11.12</scalaVersion>
	                    <encoding>UTF-8</encoding>
	                </configuration>
	                <executions>
	                    <execution>
	                        <id>compile-scala</id>
	                        <phase>compile</phase>
	                        <goals>
	                            <goal>add-source</goal>
	                            <goal>compile</goal>
	                        </goals>
	                    </execution>
	                    <execution>
	                        <id>test-compile-scala</id>
	                        <phase>test-compile</phase>
	                        <goals>
	                            <goal>add-source</goal>
	                            <goal>testCompile</goal>
	                        </goals>
	                    </execution>
	                </executions>
	            </plugin>
	
	            <!-- We use the maven-shade plugin to create a fat jar that contains all necessary dependencies. -->
	            <!-- Change the value of <mainClass>...</mainClass> if your program entry point changes. -->
	            <plugin>
	                <groupId>org.apache.maven.plugins</groupId>
	                <artifactId>maven-shade-plugin</artifactId>
	                <version>3.0.0</version>
	                <executions>
	                    <!-- Run shade goal on package phase -->
	                    <execution>
	                        <phase>package</phase>
	                        <goals>
	                            <goal>shade</goal>
	                        </goals>
	                        <configuration>
	                            <artifactSet>
	                                <excludes>
	                                    <exclude>org.apache.flink:force-shading</exclude>
	                                    <exclude>com.google.code.findbugs:jsr305</exclude>
	                                    <exclude>org.slf4j:*</exclude>
	                                    <exclude>log4j:*</exclude>
	                                </excludes>
	                            </artifactSet>
	                            <filters>
	                                <filter>
	                                    <!-- Do not copy the signatures in the META-INF folder.
	                                    Otherwise, this might cause SecurityExceptions when using the JAR. -->
	                                    <artifact>*:*</artifact>
	                                    <excludes>
	                                        <exclude>META-INF/*.SF</exclude>
	                                        <exclude>META-INF/*.DSA</exclude>
	                                        <exclude>META-INF/*.RSA</exclude>
	                                    </excludes>
	                                </filter>
	                            </filters>
	                            <transformers>
	                                <transformer implementation="org.apache.maven.plugins.shade.resource.ManifestResourceTransformer">
	                                    <mainClass>com.dajiangtai.StreamingJob</mainClass>
	                                </transformer>
	                            </transformers>
	                        </configuration>
	                    </execution>
	                </executions>
	            </plugin>
	        </plugins>
	
	        <pluginManagement>
	            <plugins>
	
	                <!-- This improves the out-of-the-box experience in Eclipse by resolving some warnings. -->
	                <plugin>
	                    <groupId>org.eclipse.m2e</groupId>
	                    <artifactId>lifecycle-mapping</artifactId>
	                    <version>1.0.0</version>
	                    <configuration>
	                        <lifecycleMappingMetadata>
	                            <pluginExecutions>
	                                <pluginExecution>
	                                    <pluginExecutionFilter>
	                                        <groupId>org.apache.maven.plugins</groupId>
	                                        <artifactId>maven-shade-plugin</artifactId>
	                                        <versionRange>[3.0.0,)</versionRange>
	                                        <goals>
	                                            <goal>shade</goal>
	                                        </goals>
	                                    </pluginExecutionFilter>
	                                    <action>
	                                        <ignore/>
	                                    </action>
	                                </pluginExecution>
	                                <pluginExecution>
	                                    <pluginExecutionFilter>
	                                        <groupId>org.apache.maven.plugins</groupId>
	                                        <artifactId>maven-compiler-plugin</artifactId>
	                                        <versionRange>[3.1,)</versionRange>
	                                        <goals>
	                                            <goal>testCompile</goal>
	                                            <goal>compile</goal>
	                                        </goals>
	                                    </pluginExecutionFilter>
	                                    <action>
	                                        <ignore/>
	                                    </action>
	                                </pluginExecution>
	                            </pluginExecutions>
	                        </lifecycleMappingMetadata>
	                    </configuration>
	                </plugin>
	            </plugins>
	        </pluginManagement>
	    </build>
	
	    <!-- This profile helps to make things run out of the box in IntelliJ -->
	    <!-- Its adds Flink's core classes to the runtime class path. -->
	    <!-- Otherwise they are missing in IntelliJ, because the dependency is 'provided' -->
	    <profiles>
	        <profile>
	            <id>add-dependencies-for-IDEA</id>
	
	            <activation>
	                <property>
	                    <name>idea.version</name>
	                </property>
	            </activation>
	
	            <dependencies>
	                <dependency>
	                    <groupId>org.apache.flink</groupId>
	                    <artifactId>flink-java</artifactId>
	                    <version>${flink.version}</version>
	                    <scope>compile</scope>
	                </dependency>
	                <dependency>
	                    <groupId>org.apache.flink</groupId>
	                    <artifactId>flink-streaming-java_${scala.binary.version}</artifactId>
	                    <version>${flink.version}</version>
	                    <scope>compile</scope>
	                </dependency>
	            </dependencies>
	        </profile>
	    </profiles>
	
	</project>



## kafka消费内容

启动kafka消费者

	./kafka-console-consumer.sh --bootstrap-server 47.112.142.231:9092 --topic purchasePathAnalysisInPut


看到kafka中记录数据如下：

	{"userId":"79","channel":"APP","eventType":"VIEW_PRODUCT","eventTime":"1610376487667","data":{"productId":133}}
	{"userId":"29","channel":"APP","eventType":"REMOVE_FROM_CART","eventTime":"1610376489031","data":{"productId":109}}
	{"userId":"62","channel":"APP","eventType":"PURCHASE","eventTime":"1610376490283","data":{"productId":129,"price":500,"amount":42}}
	{"userId":"76","channel":"APP","eventType":"REMOVE_FROM_CART","eventTime":"1610376490284","data":{"productId":141}}
	{"userId":"39","channel":"APP","eventType":"REMOVE_FROM_CART","eventTime":"1610376491009","data":{"productId":119}}
	{"userId":"35","channel":"APP","eventType":"PURCHASE","eventTime":"1610376492118","data":{"productId":137,"price":300,"amount":6}}
	{"userId":"14","channel":"APP","eventType":"VIEW_PRODUCT","eventTime":"1610376492118","data":{"productId":125}}


