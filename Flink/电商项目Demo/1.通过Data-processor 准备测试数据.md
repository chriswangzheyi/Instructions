# 1. 通过Data-processor 准备测试数据

## 下载项目

	https://github.com/CloudWise-OpenSource/Data-Processer

## 打包项目

进入到项目目录（有pom的那一层）

	mvn clean package

在target目录下可以看到生成了simulatedata-generator-0.0.1.jar文件。


## 添加到本地仓库

在target目录下执行

	mvn install:install-file -Dfile=simulatedata-generator-0.0.1.jar -DgroupId=com.cloudwise.toushibao -DartifactId=simulatedata-generator -Dversion=0.0.1 -Dpackaging=jar


## 引入依赖方法

项目的pom文件中添加jar包依赖

	<dependency>
		<groupId>com.cloudwise.toushibao</groupId>
		<artifactId>simulatedata-generator</artifactId>
		<version>0.0.1</version>
	</dependency>



## 代码


	package com.wzy.stream.userPurchaseBehaviorTracker.simulator;
	
	import com.cloudwise.sdg.dic.DicInitializer;
	import com.cloudwise.sdg.template.TemplateAnalyzer;
	import org.apache.kafka.clients.producer.KafkaProducer;
	import org.apache.kafka.clients.producer.ProducerRecord;
	
	import java.util.Properties;
	import java.util.Random;
	
	/**
	 * 模拟产生数据
	 *
	 * @author dajiangtai
	 * @create 2019-06-23-16:37
	 */
	public class UserEventsSimulator {
	    public static void main(String[] args) throws Exception{
	        //加载词典(只需执行一次即可)
	        DicInitializer.init();
	
	        //编辑模版
	        String userEventTpl = "{\"userId\":\"$Dic{userId}\",\"channel\":\"$Dic{channel}\",\"eventType\":\"$Dic{eventType}\",\"eventTime\":\"$Dic{eventTime}\",\"data\":{\"productId\":$Dic{productId}}}";
	
	        String purchaseUserEventTpl = "{\"userId\":\"$Dic{userId}\",\"channel\":\"$Dic{channel}\",\"eventType\":\"PURCHASE\",\"eventTime\":\"$Dic{eventTime}\",\"data\":{\"productId\":$Dic{productId},\"price\":$Dic{price},\"amount\":$Dic{amount}}}";
	
	        //创建模版分析器
	        TemplateAnalyzer userEventTplAnalyzer = new TemplateAnalyzer("userEvent", userEventTpl);
	
	        TemplateAnalyzer purchaseUserEventTplAnalyzer = new TemplateAnalyzer("purchaseUserEventTpl", purchaseUserEventTpl);
	
	
	        Properties props = new Properties();
	        props.put("bootstrap.servers", "47.112.142.231:9092");
	        props.put("key.serializer", "org.apache.kafka.common.serialization.StringSerializer");
	        props.put("value.serializer", "org.apache.kafka.common.serialization.StringSerializer");
	        KafkaProducer producer = new KafkaProducer<String, String>(props);
	
	        ProducerRecord record;
	        for(int i=1;i<=100000;i++){
	            //分析模版生成模拟数据
	            record = new ProducerRecord<String, String>(
	                    "purchasePathAnalysisInPut",
	                    null,
	                    new Random().nextInt()+"",
	                    userEventTplAnalyzer.analyse()); //userEventTplAnalyzer
	            producer.send(record);
	            long sleep = (long) (Math.random()*2000);
	            Thread.sleep(sleep);
	            System.out.println("------------"+sleep+"----"+sleep%2);
	
	            if(sleep%2==0&&sleep>800){
	                System.out.println("------------"+sleep+"----"+sleep%2);
	
	                record = new ProducerRecord<String, String>(
	                        "purchasePathAnalysisInPut",
	                        null,
	                        new Random().nextInt()+"",
	                        purchaseUserEventTplAnalyzer.analyse());    //purchaseUserEventTplAnalyzer
	                producer.send(record);
	            }
	        }
	    }
	}


## kafka消费内容

启动kafka消费者

	./kafka-console-consumer.sh --bootstrap-server 47.112.142.231:9092 --topic purchasePathAnalysisInPut


看到

	{"userId":"79","channel":"APP","eventType":"VIEW_PRODUCT","eventTime":"1610376487667","data":{"productId":133}}
	{"userId":"29","channel":"APP","eventType":"REMOVE_FROM_CART","eventTime":"1610376489031","data":{"productId":109}}
	{"userId":"62","channel":"APP","eventType":"PURCHASE","eventTime":"1610376490283","data":{"productId":129,"price":500,"amount":42}}
	{"userId":"76","channel":"APP","eventType":"REMOVE_FROM_CART","eventTime":"1610376490284","data":{"productId":141}}
	{"userId":"39","channel":"APP","eventType":"REMOVE_FROM_CART","eventTime":"1610376491009","data":{"productId":119}}
	{"userId":"35","channel":"APP","eventType":"PURCHASE","eventTime":"1610376492118","data":{"productId":137,"price":300,"amount":6}}
	{"userId":"14","channel":"APP","eventType":"VIEW_PRODUCT","eventTime":"1610376492118","data":{"productId":125}}


