# 13. 使用新的数据模拟器后的数据准备

##  建模过程（重复基础建设过程2-10章）

### 导入用户行为日志

进入hive：

	 load data inpath '/logdata/app/2022-10-25' into table ods.mall_app_log_dts partition (dt='2022-10-25');
	 
验证：
	
	select * from ods.mall_app_log_dts where dt='2022-10-25' limit 10;

得到：
	
	        cn.doitedu.jobs.JobHunter       7.2     中国联通        VHBIVWAWIGWP    MI-NOTE launch  27.57.10.191    27.57830180708845       119.29458743517024      5G      android 8.5     {}      最美应用        1024*768        NULL    1666627218125   2022-10-25
	        cn.doitedu.jobs.JobHunter       7.2     中国联通        VHBIVWAWIGWP    MI-NOTE categoryClick   27.57.10.191    27.57830180708845       119.29458743517024      5G      android 8.5     {"refUrl":"/jobs/job0294.html","pageId":"sea0846","url":"/search/sea0846.html","categoryId":"014"}    最美应用        1024*768        jekreoor        1666627224628   2022-10-25
	        cn.doitedu.jobs.JobHunter       7.2     中国联通        VHBIVWAWIGWP    MI-NOTE pageView        27.57.10.191    27.57830180708845       119.29458743517024      5G      android 8.5     {"refUrl":"/students/stu0087.html","pageId":"stu0974","url":"/students/stu0974.html"} 最美应用        1024*768        jekreoor        1666627227668   2022-10-25
	        cn.doitedu.jobs.JobHunter       7.2     中国联通        VHBIVWAWIGWP    MI-NOTE search  27.57.10.191    27.57830180708845       119.29458743517024      5G      android 8.5     {"productId":"00811","refUrl":"/search/sea0903.html","pageId":"s","url":"/search/s?","keyWord":"希而拍纸"}    最美应用        1024*768        jekreoor        1666627229826   2022-10-25
	        cn.doitedu.jobs.JobHunter       7.2     中国联通        VHBIVWAWIGWP    MI-NOTE adClick 27.57.10.191    27.57830180708845       119.29458743517024      5G      android 8.5     {"adId":"032","refUrl":"/courses/kylin/c085.html","pageId":"stu0214","url":"/students/stu0214.html"}  最美应用        1024*768        jekreoor        1666627244184   2022-10-25
	        cn.doitedu.jobs.JobHunter       7.2     中国联通        VHBIVWAWIGWP    MI-NOTE collect 27.57.10.191    27.57830180708845       119.29458743517024      5G      android 8.5     {"itemId":"00649","refUrl":"/contacts/con0668.html","pageId":"sha0712","url":"/shares/sha0712.html"}  最美应用        1024*768        jekreoor        1666627257942   2022-10-25
	        cn.doitedu.jobs.JobHunter       7.2     中国联通        VHBIVWAWIGWP    MI-NOTE collect 27.57.10.191    27.57830180708845       119.29458743517024      5G      android 8.5     {"itemId":"00530","refUrl":"/items/ite0404.html","pageId":"ite0344","url":"/items/ite0344.html"}      最美应用        1024*768        jekreoor        1666627271386   2022-10-25
	        cn.doitedu.jobs.JobHunter       7.2     中国联通        VHBIVWAWIGWP    MI-NOTE adClick 27.57.10.191    27.57830180708845       119.29458743517024      5G      android 8.5     {"adId":"016","refUrl":"/search/sea0764.html","pageId":"job0864","url":"/jobs/job0864.html"}  最美应用        1024*768        jekreoor        1666627287940   2022-10-25
	       cn.doitedu.study.Yiee   6.8     中国移动        PNFPMYNYLNLT    MI-6    launch  72.117.137.117  25.615668701379487      119.75212192167663      4G      android 6.5     {}      应用超市        1024*768        NULL    1666627210990   2022-10-25
	       cn.doitedu.study.Yiee   6.8     中国移动        PNFPMYNYLNLT    MI-6    fetchCoupon     72.117.137.117  25.615668701379487      119.75212192167663      4G      android 6.5     {"refUrl":"/students/stu0065.html","pageId":"sea0139","couponId":"010","url":"/search/sea0139.html"}  应用超市        1024*768        qljfjlrx        1666627217034   2022-10-25

### DWD层代码-dws用户绑定关系权重表


	-- 计算T日(2022-10-25)的绑定表
	
	-- 首选,对T日的日志进行聚合处理：统计每个（设备，账号）组合出现的会话数
	
	insert into table dws.mall_app_device_account_bind partition(dt='2022-10-25')
	
	SELECT
	    nvl(o1.device_id,o2.device_id) as device_id,
	    nvl(o1.account,o2.account) as account,
	    case 
	     when o1.device_id is not null and o2.device_id is not null then o1.weight+o2.weight
	     when o1.device_id is not null and o2.device_id is null then o1.weight
	     else o2.weight * 0.5 
	    end as weight ,
	    if(o1.device_id is not null,'2022-10-25',o2.last_login) as last_login
	
	
	FROM 
	(
	   SELECT
	     deviceid as device_id,
	     account ,
	     count(distinct sessionid) * 100 as weight
	   FROM ods.mall_app_log_dts
	   WHERE dt='2022-10-25' and trim(account) != '' and account is not null
	   GROUP BY deviceid,account
	) o1
	
	FULL JOIN 
	
	(
	   SELECT
	     device_id,
	     account,
	     weight,
	     last_login
	   FROM dws.mall_app_device_account_bind 
	   WHERE dt='2022-10-24'
	) o2
	ON concat(o1.device_id,o1.account)=concat(o2.device_id,o2.account);
	

结果：

 	select * from dws.mall_app_device_account_bind where dt='2022-10-25' limit 10;
 	
 	device_id         account      weight   last_login   dt
	---------------------------------------------------------
 	ABKAJQIOOLEH    fmgx fbx        400.0   NULL    2022-10-25
	ABLZAZBWGHTA    xtn.tnck        100.0   NULL    2022-10-25
	ABMQSISIFUCO    tbfl_fnee       100.0   NULL    2022-10-25
	ABPKYEUKTZZK    xpr lt  		100.0   NULL    2022-10-25
	ACNUYARJYCMT    酆拿    		   100.0   NULL    2022-10-25
	ACSBBKXORCCY    wqcy_ha 	    300.0   NULL    2022-10-25
	ADGQKOYHHWDZ    pt_ziwy         100.0   NULL    2022-10-25
	ADVBWZCMUYPX    py.idzk         200.0   NULL    2022-10-25
	AEVIABQAOAFQ    wto_hihx        200.0   NULL    2022-10-25
	AFOODYBISGID    窦心             200.0   NULL    2022-10-25
	

### GUID 生成

	INSERT INTO TABLE dim.dev_acc_bind_w PARTITION (dt='2022-10-25')
	
	SELECT 
	    nvl(o1.deviceid, o2.device_id) as device_id,
	    nvl(o1.account,o2.account) as account,
	    case
	        when o1.deviceid is not null and o2.device_id is not null then o1.weight+o2.weight
	        when o1.deviceid is not null and o2.device_id is null then o1.weight
	        else o2.weight*0.5
	    end as weight,
	    nvl(o1. last_login_time, o2. last_login_time) as last_login_time        
	FROM
	
	( --T日行为事件明细会话聚合数据
	SELECT
	    deviceid,
	     account,
	     count(distinct sessionid) * 100 as weight,
	     max(`timestamp`) as last_login_time
	
	FROM ods.mall_app_log_dts
	WHERE dt='2022-10-25' AND account is not null AND account!=''
	GROUP BY
	    deviceid, account
	) o1
	
	FULL JOIN
	
	( --绑定权重表T-1日数据 
	SELECT
	    device_id,
	    account,
	    weight,
	    last_login_time
	FROM dim.dev_acc_bind_w
	WHERE dt= '2022-10-24' 
	) o2
	
	ON o1.deviceid=o2.device_id AND o1.account=o2.account;

查询结果：

	select * from dim.dev_acc_bind_w where dt='2022-10-25' limit 20;
	
	device_id      account       weight    last_login_time  dt
	---------------------------------------------------------------
	ABKAJQIOOLEH    fmgx fbx        400.0   1666627427221   2022-10-25
	ABLZAZBWGHTA    xtn.tnck        100.0   1666627422254   2022-10-25
	ABMQSISIFUCO    tbfl_fnee       100.0   1666627279698   2022-10-25
	ABPKYEUKTZZK    xpr lt          100.0   1666627267684   2022-10-25
	ACNUYARJYCMT    酆拿             100.0   1666627379871   2022-10-25
	ACSBBKXORCCY    wqcy_ha         300.0   1666627425621   2022-10-25
	ADGQKOYHHWDZ    pt_ziwy         100.0   1666627234477   2022-10-25
	ADVBWZCMUYPX    py.idzk         200.0   1666627449507   2022-10-25
	AEVIABQAOAFQ    wto_hihx        200.0   1666627358726   2022-10-25
	AFOODYBISGID    窦心             200.0   1666627307107   2022-10-25
	AHBPTWXBTSHH    pv,jtln          200.0   1666627409265   2022-10-25
	AHJSTZWDWTGE    ve dwc           200.0   1666627279379   2022-10-25
	AHWMEQXJGIZW    wfw.kq           200.0   1666627342281   2022-10-25
	AISWILTFXCEF    wipw,etrd        100.0   1666627349829   2022-10-25
	AJBIQCEWFQQQ    vx tut           100.0   1666627375939   2022-10-25
	AJDESRQCAQSK    wei,voxh        100.0   1666627339890   2022-10-25
	AKZDFMMFRFGD    tbtm,utt        200.0   1666627371054   2022-10-25
	ALMBFNSNBCGJ    blc zzu         200.0   1666627327426   2022-10-25
	ALMFTDVWXVGL    wl.ctkj         100.0   1666627429076   2022-10-25
	ALSVCWDNUFSH    fpt zdvl        100.0   1666627258649   2022-10-25
	
### 空账号设备GUID映射表

	WITH TMP AS(
	    SELECT 
	        o1.device_id,
	        o1.first_login,
	        o1.last_login
	    FROM
	    (
	    SELECT
	        deviceid as device_id,
	        min(`timestamp`) as first_login,
	        max(`timestamp`) as last_login
	    FROM ods.mall_app_log_dts
	    WHERE dt='2022-10-25'
	    GROUP BY deviceid
	    HAVING max( if(trim(account)='',null,account))is null
	    ) o1
	
	    LEFT JOIN
	
	    (
	    SELECT 
	        device_id
	    FROM dim.dev_acc_bind_w
	    WHERE dt='2022-10-25'
	    ) o2
	
	    ON o1.device_id=o2.device_id
	    WHERE o2.device_id is NULL
	)
	
	
	-- 为上面找到的空设备去映射GUID
	INSERT INTO TABLE dim.dev_guid_map PARTITION (dt='2022-10-25')
	SELECT 
	    o1.device_id,
	    row_number() over() + o2.old_max  as guid,
	    o1.first_login,
	    o1.last_login
	
	FROM
	(
	    -- 真正的空设备
	    SELECT
	        tmp.device_id,
	        tmp.first_login,
	        tmp.last_login
	    FROM tmp
	
	    LEFT JOIN 
	    (
	        SELECT
	            device_id   
	        FROM dim.dev_guid_map
	        WHERE dt='2022-10-25' 
	    ) o
	    ON tmp.device_id=o.device_id
	    WHERE o.device_id is NULL
	)  o1
	
	JOIN 
	(
	SELECT nvl (max(guid) , 1000000000 ) as old_max from dim.dev_guid_map WHERE dt='2022-10-25'
	) o2
	
	UNION ALL
	
	SELECT
	    device_id,
	    guid,
	    first_login,
	    last_login 
	FROM dim.dev_guid_map 
	WHERE dt='2022-10-25';
	
查看结果：

	select * from dim.dev_guid_map where dt='2022-10-25' limit 20;

	device_id         guid          first_login      last_login      dt
	--------------------------------------------------------------------------
	ZLTIEUGTGXJF    1000000001      1666627209774   1666627278073   2022-10-25
	ZDPXUTOGOIIM    1000000002      1666627213513   1666627324219   2022-10-25
	ZBXNPOXPLXWO    1000000003      1666627211780   1666627354678   2022-10-25
	ZBGCSYQFGMYJ    1000000004      1666627215015   1666627311919   2022-10-25
	YJKYIJTWZFUZ    1000000005      1666627204084   1666627247204   2022-10-25
	YIMDQEDUCBMG    1000000006      1666627213609   1666627322714   2022-10-25
	XXIQTJZLEIFG    1000000007      1666627216376   1666627468124   2022-10-25
	XUXBFOMNTZNM    1000000008      1666627202347   1666627293854   2022-10-25
	XFUZCFAJGPVK    1000000009      1666627202587   1666627370295   2022-10-25
	XEDXGZNDBJIX    1000000010      1666627214239   1666627302631   2022-10-25
	WQPSSSFBVPBU    1000000011      1666627203927   1666627361344   2022-10-25
	WDSCONOPXHAX    1000000012      1666627207975   1666627244724   2022-10-25
	WBTYUTESUGIJ    1000000013      1666627205515   1666627415787   2022-10-25
	VMNILMMXZDDS    1000000014      1666627204270   1666627433583   2022-10-25
	VHBIVWAWIGWP    1000000015      1666627217964   1666627435740   2022-10-25
	UWADYSDTXJFC    1000000016      1666627209554   1666627410289   2022-10-25
	USVDGQAYOMFT    1000000017      1666627213725   1666627305551   2022-10-25
	UOQREMKGZQJH    1000000018      1666627216207   1666627315972   2022-10-25
	UHOUREDKQBBW    1000000019      1666627214212   1666627253778   2022-10-25
	UGXTKBIUUZLA    1000000020      1666627202520   1666627308106   2022-10-25
	

### ETL 开发流程

执行第10章内容

#### 查看结果

	select * from dwd.mall_app_event_dtl  where dt='2022-10-25' limit 20;


## 报错解决

### 错误1

	Spark：java.io.IOException: No space left on device

解决方案：

	在spark各节点上：
	mkdir /home/zheyi/tmp
	hdfs dfs -mkdir /tmp/sparktmp

配置spark.local.dir参数指定自定义的tmp目录,在spark-evn.sh文件中追加

	export SPARK_JAVA_OPTS="-Dspark.local.dir=/home/zheyi/tmp, /mnt/disk2"
