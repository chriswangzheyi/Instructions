# 03. ODS层开发

## 规划

### 存储规划

|  数据类型   | 输入路径  |目标位置（HIVE表）  |
|  ----  | ----  | ----  |
| app端埋点日志  | /logdata/app/2021-09-19/| ods.event_app_log    分区：2021-09-19 |
| wx小程序埋点日志  | /logdata/wxapp/2021-09-19/ | ods.event_wxapp_log  分区：2021-09-19 |

### 命名规范

层级.业务域_数据域_主题域_功能

比如：app事件日志ODS表：  

	ods.mall_app_log_dtl 

意思就是ods层下的mall业务，app数据域，log主题，功能是每天同步

### 入库要求

* 原始日志格式：普通文本文件，JSON数据格式，导入hive表后，要求可以很方便地select各个字段
* 分区表
* 外部表

## 前提准备

安装Hive

## 建表

### 建库

	create database  ods;

###  ods层 app原始层入库建表

	create external table ods.mall_app_log_dts
	(
	account         string,           
	appId           string,           
	appVersion      string,           
	carrier         string,           
	deviceId        string,           
	deviceType      string,           
	eventId         string,           
	ip              string,           
	latitude        double,           
	longitude       double,           
	netType         string,           
	osName          string,           
	osVersion       string,           
	properties      map<string,string>,                            
	releaseChannel  string,           
	resolution      string,           
	sessionId       string,           
	`timeStamp`       bigint  
	)   
	partitioned by (dt string)
	row format 
	serde 
	'org.apache.hive.hcatalog.data.JsonSerDe' 
	STORED AS 
	INPUTFORMAT 
	    'org.apache.hadoop.mapred.TextInputFormat'
	OUTPUTFORMAT 
	    'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'
	TBLPROPERTIES(
	    'EXTERNAL'='TRUE',
	    'comment'='this is a ods table',
	    'orc.compress'='snappy'
	)
	;   



---
# 附录



## 日志demo

### APP端埋点日志示例

	{
		"account": "Vz54E9Ya",
		"appId": "cn.doitedu.app1",
		"appVersion": "3.4",
		"carrier": "中国移动",
		"deviceId": "lzhDJKAEKEPE",
		"deviceType": "MI-6",
	"ip": "24.93.136.175",
		"latitude": 42.09287620431088,
		"longitude": 79.42106825764643,
		"netType": "WIFI",
		"osName": "android",
		"osVersion": "6.5",
		"releaseChannel": "豌豆荚",
		"resolution": "1024*768",
		"sessionId": "EUbuoZXoxwL",
		"timeStamp": 1594534406220
		"eventId": "productView",
		"properties": {
			"pageId": "646",
			"productId": "157",
			"refType": "4",
			"refUrl": "/search",
			"title": "小米10至尊版超大杯双十一大优惠立买力返现",
			"url": "items/182365930.html",
			"utm_campain": "双十一小米促销广告",
			"utm_loctype": "侧边栏广告",
			"utm_source": "爱奇艺"
		}
		
	}



### WX小程序日志示例

	{
		"account": "OojqS36Vk",
		"carrier": "中国电信",
		"deviceType": "MEIZU-ML7",
		"ip": "208.67.109.145",
		"latitude": 39.83538766367311,
		"longitude": 109.96112871255549,
		"netType": "WIFI",
		"openid": "TCEwZZNJ",
		"osName": "android",
		"osVersion": "8.5",
		"resolution": "2048*1024",
		"sessionId": "7qSqmopgg0q",
		"timeStamp": 1595752563993
		"eventId": "adClick",
		"properties": {
			"adCampain": "15",
			"adId": "5",
			"adLocation": "2",
			"pageId": "475"
		},
	}


